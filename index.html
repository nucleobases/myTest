<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payroll System Demo — 前端操作介面展示</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+TC:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root {
      color-scheme: light;
      --ink: #231f1a;
      --muted: #6b5f53;
      --paper: #f7f0e8;
      --cream: #fff8f1;
      --accent: #c65c2c;
      --accent-deep: #8f3a1f;
      --teal: #2f7f7b;
      --lime: #c9d58c;
      --chart-gross: #2f7f7b;
      --chart-deduction: #c65c2c;
      --chart-net: #2a4a3f;
      --shadow: rgba(35, 31, 26, 0.12);
      --border: rgba(35, 31, 26, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "IBM Plex Sans TC", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 15% 10%, #ffe7d3 0%, #fef7ef 35%, #f4ece1 100%);
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(120deg, rgba(198, 92, 44, 0.16), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(47, 127, 123, 0.12), transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .demo {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 80px;
    }

    .demo__header {
      display: grid;
      gap: 24px;
    }

    .demo__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-size: 14px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn:focus-visible {
      outline: 2px solid rgba(198, 92, 44, 0.5);
      outline-offset: 2px;
    }

    .btn--primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 12px 24px -18px rgba(198, 92, 44, 0.6);
    }

    .btn--ghost {
      background: #fff;
      border: 1px solid var(--border);
      color: var(--ink);
    }

    .btn--soft {
      background: rgba(47, 127, 123, 0.12);
      color: var(--teal);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .demo__stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .demo__status {
      margin-top: 0;
    }

    .status-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      box-shadow: 0 16px 28px -24px var(--shadow);
    }

    .status-card--role {
      justify-content: space-between;
    }

    .role-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    .role-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
    }

    .status-card__label {
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
    }

    .status-card__value {
      font-weight: 600;
    }

    .stat-card {
      background: #fff;
      border: 1px solid var(--border);
      padding: 18px 20px;
      border-radius: 18px;
      box-shadow: 0 18px 30px -26px var(--shadow);
    }

    .stat-card__label {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .stat-card__value {
      font-size: 22px;
      font-weight: 700;
    }

    .stat-card__note {
      color: var(--teal);
      font-size: 12px;
      margin-top: 6px;
    }

    .demo__nav {
      margin-top: 26px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: rgba(255, 255, 255, 0.7);
      padding: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    .tab {
      border: none;
      background: transparent;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 18px;
      color: var(--muted);
      cursor: pointer;
    }

    .tab--active {
      background: var(--ink);
      color: #fff;
    }

    .tab:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .is-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .rbac-note {
      display: inline-flex;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      white-space: nowrap;
    }

    .demo__main {
      margin-top: 26px;
      display: grid;
      gap: 30px;
    }

    .panel {
      display: none;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 26px;
      padding: 26px;
      box-shadow: 0 22px 40px -30px var(--shadow);
      animation: fadeUp 0.6s ease;
    }

    .panel--active {
      display: block;
    }

    .panel__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .panel__title {
      font-family: "Noto Serif TC", serif;
      font-size: 24px;
      margin: 0;
    }

    .panel__desc {
      color: var(--muted);
      margin: 6px 0 0;
      line-height: 1.6;
    }

    .panel__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-top: 16px;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 18px;
      box-shadow: 0 16px 28px -24px var(--shadow);
    }

    .card__title {
      font-weight: 700;
      margin-bottom: 10px;
    }

    .card__body {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      background: rgba(47, 127, 123, 0.12);
      color: var(--teal);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .table th,
    .table td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(35, 31, 26, 0.08);
      text-align: left;
      vertical-align: middle;
    }

    .table th {
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .table tbody tr:hover {
      background: rgba(198, 92, 44, 0.06);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(35, 31, 26, 0.08);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .badge--active {
      background: rgba(47, 127, 123, 0.18);
      color: var(--teal);
    }

    .badge--pending {
      background: rgba(201, 213, 140, 0.4);
      color: #5a6619;
    }

    .badge--warning {
      background: rgba(198, 92, 44, 0.2);
      color: var(--accent-deep);
    }

    .panel__toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 14px 0 20px;
      align-items: center;
    }

    .toolbar__field {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .toolbar__field .form-input {
      min-width: 140px;
    }

    .panel__chart {
      margin-top: 20px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 16px;
    }

    .chart__toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .chart__range {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chart-range {
      padding: 8px 14px;
    }

    .chart-range--active {
      background: var(--ink);
      color: #fff;
      border: 1px solid var(--ink);
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
      align-items: center;
    }

    .chart-legend__item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .chart-legend__swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--ink);
    }

    .chart-legend__swatch[data-color="gross"] {
      background: var(--chart-gross);
    }

    .chart-legend__swatch[data-color="deduction"] {
      background: var(--chart-deduction);
    }

    .chart-legend__swatch[data-color="net"] {
      background: var(--chart-net);
    }

    .panel__note {
      margin-top: 18px;
    }

    .panel__block {
      margin: 18px 0;
    }

    .grade-version__actions {
      margin-top: 12px;
    }

    .grade-version__table {
      margin-top: 12px;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(35, 31, 26, 0.35);
      z-index: 1000;
    }

    .modal--open {
      display: flex;
    }

    .modal__panel {
      width: min(760px, 92vw);
      max-height: 90vh;
      overflow: auto;
      background: #fff;
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 48px -28px var(--shadow);
      padding: 20px;
    }

    .modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .modal__title {
      margin: 0;
      font-family: "Noto Serif TC", serif;
      font-size: 20px;
    }

    .modal__close {
      padding: 8px 14px;
    }

    .employee-form {
      display: grid;
      gap: 18px;
    }

    .form-section__title {
      font-weight: 700;
      margin: 0 0 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 14px;
      align-items: center;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 12px;
      letter-spacing: 0.4px;
      color: var(--muted);
      font-weight: 600;
    }

    .form-input {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
      color: var(--ink);
    }

    .form-input--align-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .form-input--uppercase {
      text-transform: uppercase;
    }

    .form-input[readonly] {
      background: #f6f2ec;
      color: var(--muted);
    }

    textarea.form-input {
      min-height: 84px;
      resize: vertical;
    }

    .form-hint {
      font-size: 11px;
      color: var(--muted);
    }

    .list {
      display: grid;
      gap: 10px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .list__item {
      background: #fff;
      border: 1px solid var(--border);
      padding: 12px 14px;
      border-radius: 14px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .list__meta {
      color: var(--muted);
      font-size: 12px;
    }

    .stepper {
      display: grid;
      gap: 20px;
    }

    .step-card {
      background: rgba(255, 255, 255, 0.86);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 18px 34px -28px var(--shadow);
    }

    .step-card__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .step-card__meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step-card__index {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: var(--ink);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .step-card__title {
      font-weight: 700;
    }

    .step-card__desc {
      color: var(--muted);
      font-size: 13px;
      margin-top: 2px;
    }

    .step-card__status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .step-card__note {
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }

    .step-card--disabled {
      opacity: 0.72;
    }

    .btn--tiny {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--ink);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 16px 30px -18px rgba(35, 31, 26, 0.6);
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 20;
      font-size: 14px;
    }

    .toast--show {
      opacity: 1;
      transform: translateY(0);
    }

    dialog {
      border: none;
      border-radius: 20px;
      padding: 24px;
      max-width: 520px;
      width: 90%;
      background: var(--cream);
      box-shadow: 0 18px 40px -30px var(--shadow);
    }

    dialog::backdrop {
      background: rgba(35, 31, 26, 0.4);
    }

    .dialog__title {
      font-family: "Noto Serif TC", serif;
      margin-top: 0;
    }

    .dialog__list {
      margin: 12px 0 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.6;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(18px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 720px) {
      .demo__nav {
        border-radius: 18px;
        gap: 6px;
        padding: 6px;
      }

      .tab {
        font-size: 16px;
        padding: 6px 10px;
      }

      .status-card--role {
        align-items: flex-start;
      }

      .role-controls {
        width: 100%;
      }

      .role-field {
        min-width: 160px;
      }

      .panel {
        padding: 20px;
      }

      .panel__header {
        flex-direction: column;
        align-items: flex-start;
      }

      .list__item {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="demo">
    <header class="demo__header">
      <section class="demo__status">
        <div class="status-card status-card--role">
          <div>
            <div class="status-card__label">登入狀態</div>
            <div class="status-card__value" id="roleAccountName">登入帳號：qsan.payroll@qsan.com</div>
            <div class="list__meta" id="roleName">角色：薪資結算</div>
          </div>
          <div class="role-controls">
            <label class="role-field">
              <span class="list__meta">角色示意</span>
              <select class="form-input" id="roleSelect"></select>
              <span class="form-hint">僅 demo 顯示，正式環境由登入決定角色。</span>
            </label>
          </div>
        </div>
      </section>
      <section class="demo__stats" id="summaryCards"></section>
    </header>

    <nav class="demo__nav" aria-label="功能分頁">
      <button class="tab tab--active" data-tab="overview" data-nav="overview" data-permission="overview.view">總覽</button>
      <button class="tab" data-tab="employees" data-nav="employees" data-permission="employees.view">人事資料</button>
      <button class="tab" data-tab="salary-structure" data-nav="salary-structure" data-permission="payroll.view">薪資結構</button>
      <button class="tab" data-tab="insurance" data-nav="insurance" data-permission="insurance.view">保險管理</button>
      <button class="tab" data-tab="settlement" data-nav="settlement" data-permission="settlement.view">結薪作業</button>
      <button class="tab" data-tab="reports" data-nav="reports" data-permission="reports.view">報表中心</button>
    </nav>

    <main class="demo__main">
      <section class="panel" id="settlement" data-title="結薪作業">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">結薪作業</h2>
          </div>
          <div class="chip-group" id="settlementChips"></div>
        </div>
        <div class="stepper">
          <div class="step-card" id="settlementStep1">
            <div class="step-card__header">
              <div class="step-card__meta">
                <div class="step-card__index">1</div>
                <div>
                  <div class="step-card__title">資料確認</div>
                  <div class="step-card__desc">檢核出勤、計薪月份，並確認薪資異動彙整。</div>
                </div>
              </div>
              <div class="step-card__status">
                <span class="badge" id="settlementStep1Badge"></span>
                <span class="list__meta" id="settlementStep1Meta"></span>
              </div>
              <button class="btn btn--primary" id="settlementConfirm" data-permission="settlement.edit">完成確認</button>
            </div>
            <div class="panel__grid">
              <div class="card" id="settlementDataSummary">
                <div class="card__title">薪資資料摘要</div>
                <div class="card__body">尚未載入資料。</div>
              </div>
              <div class="card">
                <div class="card__title">薪資檢核清單</div>
                <ul class="list" id="settlementCheckList"></ul>
              </div>
              <div class="card" id="settlementIssueCard">
                <div class="card__title">薪資阻擋與警示</div>
                <div class="card__body">
                  <div class="panel__block">
                    <div class="list__meta">阻擋項目</div>
                    <ul class="list" id="settlementBlockList"></ul>
                  </div>
                  <div class="panel__block">
                    <div class="list__meta">警示項目</div>
                    <ul class="list" id="settlementWarnList"></ul>
                  </div>
                </div>
              </div>
              <div class="card" id="settlementSourceStatus">
                <div class="card__title">來源就緒狀態</div>
                <ul class="list" id="settlementSourceList"></ul>
              </div>
            </div>
          </div>

          <div class="step-card" id="settlementStep2">
            <div class="step-card__header">
              <div class="step-card__meta">
                <div class="step-card__index">2</div>
                <div>
                  <div class="step-card__title">資料計算</div>
                  <div class="step-card__desc">依薪資規則試算並產出計算快照。</div>
                </div>
              </div>
              <div class="step-card__status">
                <span class="badge" id="settlementStep2Badge"></span>
                <span class="list__meta" id="settlementStep2Meta"></span>
              </div>
              <button class="btn btn--primary" id="settlementCalculate" data-permission="settlement.edit">執行計算</button>
            </div>
            <div class="panel__grid">
              <div class="card" id="settlementCalcSummary">
                <div class="card__title">資料計算摘要</div>
                <div class="card__body">尚未產生試算資料。</div>
              </div>
              <div class="card">
                <div class="card__title">異常提示</div>
                <ul class="list" id="settlementCalcIssueList"></ul>
              </div>
              <div class="card" id="settlementCalcSnapshot">
                <div class="card__title">計算快照</div>
                <div class="card__body">尚未產生計算快照。</div>
              </div>
            </div>
            <div class="step-card__note" id="settlementStep2Note"></div>
          </div>

          <div class="step-card" id="settlementStep3">
            <div class="step-card__header">
              <div class="step-card__meta">
                <div class="step-card__index">3</div>
                <div>
                  <div class="step-card__title">計算完成</div>
                  <div class="step-card__desc">產生報表與薪資單，完成後鎖定結薪流程。</div>
                </div>
              </div>
              <div class="step-card__status">
                <span class="badge" id="settlementStep3Badge"></span>
                <span class="list__meta" id="settlementStep3Meta"></span>
              </div>
              <div class="demo__actions">
                <button class="btn btn--primary" id="settlementComplete" data-permission="settlement.edit">結薪完成</button>
                <button class="btn btn--ghost" id="settlementReopen" data-permission="settlement.edit">重新開帳</button>
              </div>
            </div>
            <div class="panel__grid">
              <div class="card" id="settlementCompleteSummary">
                <div class="card__title">結薪完成狀態</div>
                <div class="card__body">尚未完成結薪。</div>
              </div>
              <div class="card">
                <div class="card__title">匯出作業</div>
                <div class="demo__actions">
                  <button class="btn btn--primary" id="settlementExportSummary" data-permission="reports.export">產生薪資總表</button>
                  <button class="btn btn--ghost" id="settlementExportPayslip" data-permission="reports.export">產生個人薪資單</button>
                </div>
                <div class="panel__note">
                  <div class="list__meta" id="settlementExportNote">尚未產生匯出檔案。</div>
                </div>
              </div>
              <div class="card" id="settlementReportList">
                <div class="card__title">最近報表</div>
                <div class="card__body">尚未載入報表清單。</div>
              </div>
            </div>
            <div class="step-card__note" id="settlementStep3Note"></div>
          </div>
        </div>
      </section>

      <section class="panel panel--active" id="overview" data-title="總覽">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">總覽儀表板</h2>
          </div>
          <div class="chip-group" id="overviewChips"></div>
        </div>
        <div class="panel__grid" id="overviewCards"></div>
        <div class="panel__chart">
          <div class="chart__toolbar">
            <div class="chart__range">
              <button class="btn btn--ghost chart-range chart-range--active" data-range="6">最近 6 個月</button>
              <button class="btn btn--ghost chart-range" data-range="12">最近 12 個月</button>
            </div>
            <div class="chart-legend">
              <span class="chart-legend__item"><span class="chart-legend__swatch" data-color="gross"></span>應發總額</span>
              <span class="chart-legend__item"><span class="chart-legend__swatch" data-color="deduction"></span>扣款總額</span>
              <span class="chart-legend__item"><span class="chart-legend__swatch" data-color="net"></span>實領總額</span>
            </div>
          </div>
          <canvas id="payrollChart" height="140"></canvas>
        </div>
        <div class="panel__grid">
          <div class="card">
            <div class="card__title">近期操作紀錄</div>
            <ul class="list" id="activityList"></ul>
          </div>
          <div class="card">
            <div class="card__title">本月費用結構</div>
            <div class="card__body" id="costSummary"></div>
          </div>
        </div>
      </section>

      <section class="panel" id="employees" data-title="人事資料">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">人事資料</h2>
          </div>
          <button class="btn btn--primary" id="addEmployee" data-permission="employees.edit">新增員工</button>
        </div>
        <div class="panel__grid">
          <div class="card" id="employeeSettlementCheck">
            <div class="card__title">結薪檢核</div>
            <div class="card__body">尚未載入結薪檢核資訊。</div>
          </div>
        </div>
        <div class="panel__toolbar">
          <span class="chip">國別：本國／外國</span>
          <span class="chip">最低工資：27,470 元</span>
          <span class="chip">眷屬數上限：3</span>
        </div>
        <div class="card">
          <table class="table">
            <thead>
              <tr>
                <th>員工編號</th>
                <th>中文姓名</th>
                <th>英文姓名</th>
                <th>部門</th>
                <th>對內職稱</th>
                <th>職等</th>
                <th>國別</th>
                <th>在職狀態</th>
                <th>到職日</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="employeeTable"></tbody>
          </table>
        </div>
        <div class="panel__grid">
          <div class="card" id="employeePreview">
            <div class="card__title">人事資料摘要</div>
            <div class="card__body">點選「查看」或「新增員工」以顯示資料摘要。</div>
          </div>
        </div>
      </section>

      <section class="panel" id="salary-structure" data-title="薪資結構">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">薪資結構</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" id="addSalaryStructure" data-permission="payroll.edit">建立薪資結構</button>
          </div>
        </div>
        <div class="panel__grid">
          <div class="card" id="salaryStructureSummary">
            <div class="card__title">薪資結構摘要</div>
            <div class="card__body">尚未載入薪資結構摘要。</div>
          </div>
          <div class="card">
            <div class="card__title">異動待覆核</div>
            <ul class="list" id="salaryStructureChangeList"></ul>
          </div>
        </div>
        <div class="panel__toolbar">
          <span class="chip">薪資構成：本薪／伙食費／主管津貼／專業津貼／交通津貼／全勤</span>
          <span class="chip">身分別：月薪／時薪</span>
          <span class="chip">調整需薪資角色覆核</span>
          <span class="chip">結構更新後需重新結薪確認</span>
        </div>
        <div class="card">
          <table class="table">
            <thead>
              <tr>
                <th>員工編號</th>
                <th>姓名</th>
                <th>部門</th>
                <th>身分別</th>
                <th>本薪</th>
                <th>伙食費</th>
                <th>主管津貼</th>
                <th>專業津貼</th>
                <th>交通津貼</th>
                <th>全勤</th>
                <th>津貼合計</th>
                <th>生效日</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="salaryStructureTable"></tbody>
          </table>
        </div>
        <div class="card panel__note" id="salaryStructureNote">
          <div class="card__title">結構更新提示</div>
          <div class="card__body" id="salaryStructureNoteBody">尚未更新薪資結構。</div>
        </div>
      </section>

      <section class="panel" id="salary-structure-detail" data-title="薪資結構明細">
        <div class="panel__header">
          <div>
            <h2 class="panel__title" id="salaryStructureTitle">薪資結構明細</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" id="submitSalaryStructure" data-permission="payroll.edit">儲存調整</button>
            <button class="btn btn--ghost" data-nav="salary-structure" data-permission="payroll.view">返回薪資結構</button>
          </div>
        </div>
        <div class="panel__grid">
          <div class="card" id="salaryStructureTarget">
            <div class="card__title">適用對象</div>
            <div class="card__body">尚未選擇薪資結構對象。</div>
          </div>
          <div class="card" id="salaryStructurePreview">
            <div class="card__title">試算摘要</div>
            <div class="card__body">尚未載入薪資結構試算。</div>
          </div>
        </div>
        <div class="card" id="salaryStructureForm">
          <div class="card__title">薪資結構設定</div>
          <div class="card__body">尚未載入薪資結構設定。</div>
        </div>
        <div class="card panel__note" id="salaryStructureDetailNote">
          <div class="card__title">調整提醒</div>
          <div class="card__body" id="salaryStructureDetailNoteBody">尚未產生薪資結構異動。</div>
        </div>
      </section>

      <section class="panel" id="insurance" data-title="保險管理">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">保險管理與級距</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--ghost" id="toggleVersion" data-permission="insurance.edit">切換啟用版本</button>
            <button class="btn btn--soft" data-nav="labor-grade" data-label="勞保級距維護" data-permission="insurance.edit">勞保級距維護</button>
            <button class="btn btn--soft" data-nav="health-grade" data-label="健保級距維護" data-permission="insurance.edit">健保級距維護</button>
          </div>
        </div>
        <div class="panel__grid">
          <div class="card" id="insuranceSettlementCheck">
            <div class="card__title">結薪檢核</div>
            <div class="card__body">尚未載入結薪檢核資訊。</div>
          </div>
        </div>
        <div class="panel__grid">
          <div class="card">
            <div class="card__title">啟用中版本</div>
            <table class="table">
              <thead>
                <tr>
                  <th>保險類型</th>
                  <th>版本代碼</th>
                  <th>生效日</th>
                  <th>狀態</th>
                </tr>
              </thead>
              <tbody id="versionTable"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card__title">投保薪資級距（節錄）</div>
            <table class="table">
              <thead>
                <tr>
                  <th>級距代碼</th>
                  <th>薪資區間</th>
                  <th>投保薪資</th>
                </tr>
              </thead>
              <tbody id="gradeTable"></tbody>
            </table>
          </div>
        </div>
        <div class="card" style="margin-top: 18px;">
          <div class="card__title">費率與分攤比例</div>
          <table class="table">
            <thead>
              <tr>
                <th>保險類型</th>
                <th>費率</th>
                <th>員工負擔</th>
                <th>雇主負擔</th>
                <th>政府負擔</th>
              </tr>
            </thead>
            <tbody id="rateTable"></tbody>
          </table>
        </div>
        <div class="card panel__note" id="insuranceNotice">
          <div class="card__title">版本狀態</div>
          <div class="card__body">點選「切換啟用版本」以更新最新法規版本。</div>
        </div>
      </section>

      <section class="panel" id="payroll" data-title="薪資計算">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">薪資計算與試算</h2>
          </div>
          <button class="btn btn--primary" id="recalcPayroll" data-permission="payroll.edit">執行試算</button>
        </div>
        <div class="panel__toolbar">
          <div class="toolbar__field">
            <span class="list__meta">計算月份</span>
            <select class="form-input" id="payrollMonth" data-permission="payroll.edit" data-rbac-label="計算月份"></select>
          </div>
          <span class="chip">加班費：前 2 小時 1.34 倍、其後 1.67 倍</span>
          <span class="chip">勞退雇主提繳 6%</span>
        </div>
        <div class="card">
          <table class="table">
            <thead>
              <tr>
                <th>薪資編號</th>
                <th>員工</th>
                <th>應發</th>
                <th>投保薪資</th>
                <th>勞保(員工)</th>
                <th>健保(員工)</th>
                <th>實領</th>
                <th>狀態</th>
                <th>明細</th>
              </tr>
            </thead>
            <tbody id="payrollTable"></tbody>
          </table>
        </div>
        <div class="card panel__note" id="payrollNotice">
          <div class="card__title">試算結果摘要</div>
          <div class="card__body">點選「執行試算」後顯示本月試算摘要。</div>
        </div>
      </section>

      <section class="panel" id="reports" data-title="報表中心">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">報表中心</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" id="exportSummary" data-permission="reports.export">產生薪資總表</button>
            <button class="btn btn--ghost" id="exportPayslip" data-permission="reports.export">產生個人薪資單</button>
          </div>
        </div>
        <div class="panel__toolbar">
          <div class="toolbar__field">
            <span class="list__meta">結算月份</span>
            <select class="form-input" id="reportMonthFilter"></select>
          </div>
          <span class="list__meta" id="reportFilterSummary"></span>
        </div>
        <div class="card">
          <table class="table">
            <thead>
              <tr>
                <th>報表編號</th>
                <th>類型</th>
                <th>格式</th>
                <th>產生時間</th>
                <th>狀態</th>
                <th>查看</th>
              </tr>
            </thead>
            <tbody id="reportTable"></tbody>
          </table>
        </div>
        <div class="card panel__note" id="reportNotice">
          <div class="card__title">匯出檔案</div>
          <div class="card__body">點選匯出按鈕後，將顯示最新產生的報表資訊。</div>
        </div>
      </section>

      <section class="panel" id="employee-create" data-title="新增員工">
        <div class="panel__header">
          <div>
            <h2 class="panel__title" id="employeeFormTitle">新增員工</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" id="submitEmployeeCreate" data-permission="employees.edit">送出新增</button>
            <button class="btn btn--ghost" data-nav="employees" data-permission="employees.view">返回人事資料</button>
          </div>
        </div>
        <div class="card" id="employeeCreateForm">
          <div class="card__title">員工資料</div>
          <div class="card__body">尚未產生待新增的員工資料。</div>
        </div>
      </section>

      <section class="panel" id="employee-detail" data-title="員工明細">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">員工明細</h2>
          </div>
          <button class="btn btn--ghost" data-nav="employees" data-permission="employees.view">返回人事資料</button>
        </div>
        <div class="panel__grid">
          <div class="card" id="employeeDetailBody">
            <div class="card__title">員工資料</div>
            <div class="card__body">尚未選擇員工。</div>
          </div>
          <div class="card" id="employeeDetailPayroll" data-permission="payroll.view" data-rbac-label="薪資摘要">
            <div class="card__title">最新薪資摘要</div>
            <div class="card__body">尚未載入薪資資訊。</div>
          </div>
        </div>
      </section>

      <section class="panel" id="insurance-detail" data-title="保險版本明細">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">保險版本明細</h2>
          </div>
          <button class="btn btn--ghost" data-nav="insurance" data-permission="insurance.view">返回保險管理</button>
        </div>
        <div class="panel__grid">
          <div class="card" id="insuranceDetailBody">
            <div class="card__title">版本摘要</div>
            <div class="card__body">尚未載入版本資訊。</div>
          </div>
          <div class="card" id="insuranceDetailRates">
            <div class="card__title">費率資訊</div>
            <div class="card__body">尚未載入費率資訊。</div>
          </div>
        </div>
      </section>

      <section class="panel" id="labor-grade" data-title="勞保級距維護">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">勞保投保薪資級距維護</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" data-grade-action="create" data-grade-type="labor" data-permission="insurance.edit">新增級距</button>
            <button class="btn btn--ghost" data-nav="insurance" data-permission="insurance.view">返回保險管理</button>
          </div>
        </div>
        <div class="card panel__block" id="laborGradeVersion">
          <div class="card__title">版本狀態</div>
          <div class="card__body">尚未載入版本狀態。</div>
        </div>
        <div class="panel__grid">
          <div class="card">
            <div class="card__title">勞保投保薪資級距</div>
            <table class="table">
              <thead>
                <tr>
                  <th>級距代碼</th>
                  <th>版本代碼</th>
                  <th>薪資區間</th>
                  <th>投保薪資</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="laborGradeTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" id="health-grade" data-title="健保級距維護">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">健保投保薪資級距維護</h2>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" data-grade-action="create" data-grade-type="health" data-permission="insurance.edit">新增級距</button>
            <button class="btn btn--ghost" data-nav="insurance" data-permission="insurance.view">返回保險管理</button>
          </div>
        </div>
        <div class="card panel__block" id="healthGradeVersion">
          <div class="card__title">版本狀態</div>
          <div class="card__body">尚未載入版本狀態。</div>
        </div>
        <div class="panel__grid">
          <div class="card">
            <div class="card__title">健保投保薪資級距</div>
            <table class="table">
              <thead>
                <tr>
                  <th>級距代碼</th>
                  <th>版本代碼</th>
                  <th>薪資區間</th>
                  <th>投保薪資</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="healthGradeTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" id="payroll-detail" data-title="薪資明細">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">薪資明細</h2>
          </div>
          <button class="btn btn--ghost" data-nav="settlement" data-permission="settlement.view">返回結薪作業</button>
        </div>
        <div class="panel__grid">
          <div class="card" id="payrollDetailBody">
            <div class="card__title">薪資明細</div>
            <div class="card__body">尚未選擇薪資資料。</div>
          </div>
          <div class="card" id="payrollDetailInsurance">
            <div class="card__title">保險扣款與雇主成本</div>
            <div class="card__body">尚未載入保險資訊。</div>
          </div>
        </div>
      </section>

      <section class="panel" id="report-detail" data-title="報表明細">
        <div class="panel__header">
          <div>
            <h2 class="panel__title">報表明細</h2>
          </div>
          <button class="btn btn--ghost" data-nav="settlement" data-permission="settlement.view">返回結薪作業</button>
        </div>
        <div class="panel__grid">
          <div class="card" id="reportDetailBody">
            <div class="card__title">報表資訊</div>
            <div class="card__body">尚未選擇報表。</div>
          </div>
          <div class="card" id="reportDetailPreview">
            <div class="card__title">資料預覽</div>
            <div class="card__body">尚未載入資料。</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal" id="gradeModal" aria-hidden="true">
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="gradeModalTitle">
      <div class="modal__header">
        <h3 class="modal__title" id="gradeModalTitle">級距編輯</h3>
        <button class="btn btn--ghost modal__close" type="button" id="gradeModalClose">關閉</button>
      </div>
      <div class="modal__body" id="gradeModalBody"></div>
    </div>
  </div>

  <div class="modal" id="gradeVersionModal" aria-hidden="true">
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="gradeVersionModalTitle">
      <div class="modal__header">
        <h3 class="modal__title" id="gradeVersionModalTitle">級距版本代碼</h3>
        <button class="btn btn--ghost modal__close" type="button" id="gradeVersionModalClose">關閉</button>
      </div>
      <div class="modal__body" id="gradeVersionModalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const formatter = new Intl.NumberFormat("zh-Hant-TW");
    const currency = new Intl.NumberFormat("zh-Hant-TW", { style: "currency", currency: "TWD", maximumFractionDigits: 0 });
    const rules = {
      minWage: 27470,
      laborRate: 0.12,
      laborShare: { employee: 0.2, employer: 0.7, government: 0.1 },
      healthRate: 0.0517,
      healthShare: { employee: 0.3, employer: 0.6, government: 0.1 },
      pensionEmployerRate: 0.06,
      maxDependents: 3
    };

    const gradeTable = [
      { code: "L01", min: 27470, max: 27470, insured: 27470 },
      { code: "L02", min: 27471, max: 28800, insured: 28800 },
      { code: "L03", min: 28801, max: 30300, insured: 30300 },
      { code: "L04", min: 30301, max: 31800, insured: 31800 },
      { code: "L05", min: 31801, max: 33300, insured: 33300 },
      { code: "L06", min: 33301, max: 34800, insured: 34800 },
      { code: "L07", min: 34801, max: 36300, insured: 36300 },
      { code: "L08", min: 36301, max: 38200, insured: 38200 },
      { code: "L09", min: 38201, max: 40100, insured: 40100 },
      { code: "L10", min: 40101, max: 42000, insured: 42000 },
      { code: "L11", min: 42001, max: 43900, insured: 43900 },
      { code: "L12", min: 43901, max: 45800, insured: 45800 },
      { code: "L13", min: 45801, max: 47700, insured: 47700 },
      { code: "L14", min: 47701, max: 50600, insured: 50600 },
      { code: "L15", min: 50601, max: 53000, insured: 53000 },
      { code: "L16", min: 53001, max: 57800, insured: 57800 },
      { code: "L17", min: 57801, max: 60800, insured: 60800 },
      { code: "L18", min: 60801, max: 63800, insured: 63800 }
    ];

    const state = {
      employees: [],
      insuranceVersions: [],
      insuranceRates: [],
      gradeData: {},
      gradeFormState: {},
      gradeVersion: {},
      payrolls: [],
      reportHistory: [],
      reports: [],
      reportFilterMonth: "all",
      activities: [],
      pendingEmployee: null,
      employeeFormMode: "create",
      editingEmployeeId: null,
      salaryStructureMode: "edit",
      salaryStructureEditingId: null,
      insuranceSnapshots: null,
      currentRole: "payroll",
      settlement: {
        confirmedAt: "",
        calculatedAt: "",
        completedAt: "",
        needsConfirm: true,
        needsRecalc: true,
        lock: false
      },
      settlementData: {
        seed: 0,
        attendance: { month: "", imported: 0, missing: 0, lastSync: "" },
        employeeIssueCount: 0,
        personnelChangeCount: 0,
        salaryChangeCount: 0,
        sourceUpdatedAt: {
          employees: "",
          insurance: "",
          salaryStructure: ""
        }
      },
      monthlyHistory: [],
      historyRange: 6
    };

    const roleDefinitions = [
      {
        id: "admin",
        label: "系統管理員",
        account: "qsan.admin@qsan.com",
        permissions: [
          "overview.view",
          "employees.view",
          "employees.edit",
          "insurance.view",
          "insurance.edit",
          "payroll.view",
          "payroll.edit",
          "settlement.view",
          "settlement.edit",
          "reports.view",
          "reports.export"
        ]
      },
      {
        id: "hr",
        label: "人資管理",
        account: "qsan.hr@qsan.com",
        permissions: ["overview.view", "employees.view", "employees.edit"]
      },
      {
        id: "insurance",
        label: "保險管理",
        account: "qsan.insurance@qsan.com",
        permissions: ["overview.view", "insurance.view", "insurance.edit"]
      },
      {
        id: "payroll",
        label: "薪資結算",
        account: "qsan.payroll@qsan.com",
        permissions: [
          "overview.view",
          "employees.view",
          "insurance.view",
          "payroll.view",
          "payroll.edit",
          "settlement.view",
          "settlement.edit",
          "reports.view",
          "reports.export"
        ]
      },
      {
        id: "auditor",
        label: "稽核主管",
        account: "qsan.audit@qsan.com",
        permissions: ["overview.view", "employees.view", "insurance.view", "payroll.view", "settlement.view", "reports.view"]
      }
    ];

    const moduleAccessMap = [
      { id: "overview", label: "總覽", permission: "overview.view" },
      { id: "employees", label: "人事資料", permission: "employees.view" },
      { id: "salary-structure", label: "薪資結構", permission: "payroll.view" },
      { id: "insurance", label: "保險管理", permission: "insurance.view" },
      { id: "settlement", label: "結薪作業", permission: "settlement.view" },
      { id: "reports", label: "報表中心", permission: "reports.view" }
    ];

    const pagePermissions = {
      overview: "overview.view",
      employees: "employees.view",
      "employee-detail": "employees.view",
      "employee-create": "employees.edit",
      "salary-structure": "payroll.view",
      "salary-structure-detail": "payroll.view",
      insurance: "insurance.view",
      "insurance-detail": "insurance.view",
      "labor-grade": "insurance.edit",
      "health-grade": "insurance.edit",
      payroll: "payroll.view",
      "payroll-detail": "payroll.view",
      settlement: "settlement.view",
      reports: "reports.view",
      "report-detail": "reports.view"
    };

    const nameSeeds = ["雅婷", "冠宇", "佩珊", "明哲", "昱廷", "家瑜", "彥成", "佳穎", "柏翰", "姿妤", "承翰", "佩臻", "子瑜", "宇豪", "宜蓉", "柏宏", "婉婷", "修平"];
    const surnames = ["陳", "林", "黃", "張", "李", "王", "吳", "蔡", "楊", "郭", "洪", "曾"];
    const englishFirstNames = ["Alex", "Ivy", "Kevin", "Sophie", "Lucas", "Mia", "Ethan", "Olivia", "Daniel", "Chloe", "Jason", "Nina"];
    const englishLastNames = ["Chen", "Lin", "Huang", "Chang", "Lee", "Wang", "Wu", "Tsai", "Yang", "Kuo", "Hung", "Tseng"];
    const departments = [
      { code: "D001", name: "研發處" },
      { code: "D002", name: "營運處" },
      { code: "D003", name: "人資處" },
      { code: "D004", name: "財會處" },
      { code: "D005", name: "客服處" }
    ];
    const jobTitlesExternal = ["工程師", "專案經理", "資深工程師", "人資專員", "財務分析師", "營運主管", "客服經理"];
    const jobTitlesInternal = ["軟體工程師", "系統工程師", "專案副理", "人資夥伴", "財會專員", "營運管理師", "客服專員"];
    const educations = ["高中", "專科", "學士", "碩士", "博士"];
    const schools = ["國立臺灣大學", "國立清華大學", "國立陽明交通大學", "國立成功大學", "國立政治大學", "國立臺灣科技大學", "輔仁大學", "淡江大學"];
    const majors = ["資訊工程", "企業管理", "財務金融", "人力資源", "電機工程", "工業工程", "會計學", "資訊管理"];
    const bankCodes = ["004", "005", "006", "007", "008", "009", "012", "013"];
    const idLetters = ["A", "B", "C", "D", "E", "F", "G", "H", "J", "K", "L", "M", "N", "P", "Q", "R", "S", "T", "U", "V", "X", "Y", "W", "Z", "I", "O"];

    const randomChoice = (list) => list[Math.floor(Math.random() * list.length)];
    const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const padNumber = (value, length) => String(value).padStart(length, "0");

    /**
     * Normalize allowance values into a complete breakdown.
     * @param {object} allowances
     * @returns {{meal: number, supervisor: number, professional: number, transport: number, attendance: number}}
     */
    const getAllowanceBreakdown = (allowances = {}) => ({
      meal: Number(allowances.meal) || 0,
      supervisor: Number(allowances.supervisor) || 0,
      professional: Number(allowances.professional) || 0,
      transport: Number(allowances.transport) || 0,
      attendance: Number(allowances.attendance) || 0
    });

    /**
     * Sum allowance breakdown for payroll calculation.
     * @param {object} allowances
     * @returns {number}
     */
    const getAllowanceTotal = (allowances = {}) => {
      const breakdown = getAllowanceBreakdown(allowances);
      return breakdown.meal + breakdown.supervisor + breakdown.professional + breakdown.transport + breakdown.attendance;
    };

    /**
     * Format a datetime value for display.
     * @param {string|object} value
     * @returns {string}
     */
    const formatDateTime = (value) => {
      if (!value) {
        return "";
      }
      return dayjs(value).format("YYYY-MM-DD HH:mm");
    };

    /**
     * Refresh settlement summary data based on current state.
     * @returns {void}
     */
    const refreshSettlementData = () => {
      const totalEmployees = state.employees.length;
      const onDutyEmployees = state.employees.filter((item) => item.employmentStatus === "在職");
      const onDutyMaleCount = onDutyEmployees.filter((item) => item.gender === "M").length;
      const onDutyFemaleCount = onDutyEmployees.filter((item) => item.gender === "F").length;
      const seed = state.settlementData.seed || 0;
      const month = document.getElementById("payrollMonth")?.value || dayjs().format("YYYY-MM");
      const missing = Math.min(2, Math.max(0, Math.floor(totalEmployees / 4) + seed - 1));
      const imported = Math.max(0, totalEmployees - missing);
      const lastSync = state.settlementData.attendance?.lastSync || dayjs().subtract(2, "hour").format("YYYY-MM-DD HH:mm");
      const salaryChangeCount = Math.min(4, Math.max(0, Math.floor(totalEmployees / 6) + seed - 1));
      const personnelChangeCount = Math.min(3, Math.max(0, Math.floor(totalEmployees / 7) + seed));
      const sourceUpdatedAt = state.settlementData.sourceUpdatedAt || {};
      state.settlementData = {
        ...state.settlementData,
        attendance: {
          month,
          imported,
          missing,
          lastSync
        },
        employeeIssueCount: Math.min(3, Math.max(0, Math.floor(totalEmployees / 5) + seed)),
        personnelChangeCount,
        salaryChangeCount,
        sourceUpdatedAt
      };
    };

    /**
     * Initialize settlement demo data.
     * @returns {void}
     */
    const initSettlementData = () => {
      const now = dayjs();
      state.settlementData = {
        seed: randomInt(0, 2),
        attendance: { month: "", imported: 0, missing: 0, lastSync: dayjs().subtract(2, "hour").format("YYYY-MM-DD HH:mm") },
        employeeIssueCount: 0,
        personnelChangeCount: 0,
        salaryChangeCount: 0,
        sourceUpdatedAt: {
          employees: now.subtract(1, "day").format("YYYY-MM-DD HH:mm"),
          insurance: now.subtract(2, "day").format("YYYY-MM-DD HH:mm"),
          salaryStructure: now.subtract(8, "hour").format("YYYY-MM-DD HH:mm")
        }
      };
      refreshSettlementData();
    };

    /**
     * Update settlement source timestamp after data changes.
     * @param {string} sourceKey
     * @returns {void}
     */
    const touchSettlementSource = (sourceKey) => {
      if (!sourceKey) {
        return;
      }
      if (!state.settlementData.sourceUpdatedAt) {
        state.settlementData.sourceUpdatedAt = {};
      }
      state.settlementData.sourceUpdatedAt[sourceKey] = dayjs().format("YYYY-MM-DD HH:mm");
    };

    /**
     * Map a check status to badge metadata.
     * @param {string} status
     * @returns {{label: string, className: string}}
     */
    const getStatusBadge = (status) => {
      if (status === "ok") {
        return { label: "正常", className: "badge--active" };
      }
      if (status === "block") {
        return { label: "阻擋", className: "badge--warning" };
      }
      return { label: "警示", className: "badge--pending" };
    };

    const getCurrentRole = () => roleDefinitions.find((role) => role.id === state.currentRole) || roleDefinitions[0];

    /**
     * Check whether current role includes a permission.
     * @param {string} permission
     * @returns {boolean}
     */
    const hasPermission = (permission) => {
      if (!permission) {
        return true;
      }
      const role = getCurrentRole();
      return role.permissions.includes(permission);
    };

    /**
     * Render current account and role name.
     * @returns {void}
     */
    const renderRoleStatus = () => {
      const role = getCurrentRole();
      const accountEl = document.getElementById("roleAccountName");
      const roleEl = document.getElementById("roleName");
      if (accountEl) {
        accountEl.textContent = `登入帳號：${role.account || "demo.user@qsan.com"}`;
      }
      if (roleEl) {
        roleEl.textContent = `角色：${role.label}`;
      }
    };

    /**
     * Get required permission for a page id.
     * @param {string} pageId
     * @returns {string}
     */
    const getPagePermission = (pageId) => pagePermissions[pageId] || "";

    /**
     * Check whether current role can access the page.
     * @param {string} pageId
     * @returns {boolean}
     */
    const canAccessPage = (pageId) => hasPermission(getPagePermission(pageId));

    /**
     * Resolve the first accessible page for fallback navigation.
     * @returns {string}
     */
    const getFallbackPage = () => moduleAccessMap.find((item) => hasPermission(item.permission))?.id || "overview";

    /**
     * Apply RBAC permissions to UI elements.
     * @returns {void}
     */
    const applyRbacToElements = () => {
      document.querySelectorAll("[data-permission]").forEach((element) => {
        const permission = element.dataset.permission || "";
        const allowed = hasPermission(permission);
        const baseLabel = element.dataset.rbacLabel || element.textContent?.trim();
        const defaultNote = permission.endsWith(".view")
          ? "無檢視權限"
          : permission.includes("export")
            ? "無匯出權限"
            : "無操作權限";
        const noteText = element.dataset.rbacNote
          || (baseLabel ? `${baseLabel}：${defaultNote}` : defaultNote);
        const placeholderId = element.dataset.rbacPlaceholderId;
        const placeholder = placeholderId ? document.getElementById(placeholderId) : null;
        const allowPlaceholder = element.dataset.rbacSilent !== "true" && !element.closest(".demo__nav");

        if (!allowed) {
          if (!element.dataset.rbacHidden) {
            element.dataset.rbacPrevHidden = element.hidden ? "true" : "false";
          }
          element.hidden = true;
          element.dataset.rbacHidden = "true";
          element.setAttribute("aria-hidden", "true");
          if (allowPlaceholder) {
            if (!placeholder) {
              const note = document.createElement("span");
              const noteId = `rbac-note-${Math.random().toString(36).slice(2, 8)}`;
              note.id = noteId;
              note.className = "rbac-note";
              note.textContent = noteText;
              element.dataset.rbacPlaceholderId = noteId;
              element.insertAdjacentElement("afterend", note);
            } else {
              placeholder.textContent = noteText;
              placeholder.hidden = false;
            }
          } else if (placeholder) {
            placeholder.remove();
            delete element.dataset.rbacPlaceholderId;
          }
          return;
        }

        if (element.dataset.rbacHidden === "true") {
          const wasHidden = element.dataset.rbacPrevHidden === "true";
          element.hidden = wasHidden;
          delete element.dataset.rbacHidden;
          delete element.dataset.rbacPrevHidden;
        } else {
          element.hidden = false;
        }
        element.setAttribute("aria-hidden", element.hidden ? "true" : "false");
        if (placeholder) {
          placeholder.remove();
          delete element.dataset.rbacPlaceholderId;
        }
      });
    };

    /**
     * Build settlement data validation checks.
     * @returns {{id: string, label: string, detail: string, status: string, actionNav?: string, actionLabel?: string}[]}
     */
    const buildSettlementChecks = () => {
      refreshSettlementData();
      const attendance = state.settlementData.attendance;
      const totalEmployees = state.employees.length;
      const salaryChangeCount = state.settlementData.salaryChangeCount;
      const month = attendance.month || dayjs().format("YYYY-MM");
      const checks = [
        {
          id: "attendance",
          label: "出勤資料匯入",
          detail: `已匯入 ${attendance.imported}/${totalEmployees} 筆，缺漏 ${attendance.missing} 筆`,
          status: attendance.missing >= 3 ? "block" : attendance.missing > 0 ? "warn" : "ok",
          actionNav: "overview",
          actionLabel: "總覽"
        },
        {
          id: "payroll-month",
          label: "計薪月份",
          detail: month,
          status: month ? "ok" : "block",
          actionNav: "settlement",
          actionLabel: "結薪作業"
        },
        {
          id: "salary-change",
          label: "薪資異動彙整",
          detail: salaryChangeCount ? `本月 ${salaryChangeCount} 筆異動需覆核` : "未偵測到異動",
          status: salaryChangeCount ? "warn" : "ok",
          actionNav: "salary-structure",
          actionLabel: "薪資結構"
        }
      ];
      return checks;
    };

    /**
     * Build settlement source readiness list.
     * @returns {{id: string, label: string, detail: string, status: string, actionNav?: string, actionLabel?: string, meta?: string}[]}
     */
    const buildSettlementSources = () => {
      const labor = state.insuranceVersions.find((item) => item.type === "勞保");
      const health = state.insuranceVersions.find((item) => item.type === "健保");
      const hasInsurance = labor && health;
      const hasActiveGrade = Boolean(state.gradeVersion?.labor?.activeCode && state.gradeVersion?.health?.activeCode);
      const issueCount = state.settlementData.employeeIssueCount;
      const salaryChangeCount = state.settlementData.salaryChangeCount;
      const employeeStatus = issueCount >= 3 ? "block" : issueCount > 0 ? "warn" : "ok";
      const employeeUpdatedAt = state.settlementData.sourceUpdatedAt?.employees;
      const insuranceUpdatedAt = state.settlementData.sourceUpdatedAt?.insurance;
      const salaryUpdatedAt = state.settlementData.sourceUpdatedAt?.salaryStructure;
      return [
        {
          id: "source-employee",
          label: "人事資料",
          detail: issueCount ? `待補 ${issueCount} 筆（帳務/到離職）` : "資料完整",
          status: employeeStatus,
          actionNav: "employees",
          actionLabel: "人事資料",
          meta: employeeUpdatedAt ? `最後更新 ${formatDateTime(employeeUpdatedAt)}` : "尚未更新"
        },
        {
          id: "source-salary-structure",
          label: "薪資結構",
          detail: salaryChangeCount ? `本月 ${salaryChangeCount} 筆異動需覆核` : "未偵測到異動",
          status: salaryChangeCount ? "warn" : "ok",
          actionNav: "salary-structure",
          actionLabel: "薪資結構",
          meta: salaryUpdatedAt ? `最後更新 ${formatDateTime(salaryUpdatedAt)}` : "尚未更新"
        },
        {
          id: "source-insurance",
          label: "保險版本",
          detail: hasInsurance ? `${labor.code} / ${health.code}` : "尚未啟用保險版本",
          status: hasInsurance ? "ok" : "block",
          actionNav: "insurance",
          actionLabel: "保險管理",
          meta: insuranceUpdatedAt ? `最後更新 ${formatDateTime(insuranceUpdatedAt)}` : "尚未更新"
        },
        {
          id: "source-grade",
          label: "投保級距版本",
          detail: hasActiveGrade
            ? `勞保 ${state.gradeVersion.labor.activeCode} / 健保 ${state.gradeVersion.health.activeCode}`
            : "尚未設定啟用級距版本",
          status: hasActiveGrade ? "ok" : "block",
          actionNav: "insurance",
          actionLabel: "保險管理",
          meta: insuranceUpdatedAt ? `最後更新 ${formatDateTime(insuranceUpdatedAt)}` : "尚未更新"
        }
      ];
    };

    /**
     * Build calculation issues list for settlement step 2.
     * @returns {{label: string, detail: string, status: string}[]}
     */
    const buildSettlementCalculationIssues = () => {
      const pending = state.payrolls.filter((item) => item.status === "待結算");
      const lowNet = state.payrolls.filter((item) => item.netSalary < rules.minWage);
      const heavyOvertime = state.payrolls.filter((item) => item.overtimeHours >= 12);
      const issues = [];
      if (pending.length) {
        issues.push({
          label: "待結算薪資",
          detail: `共 ${pending.length} 筆待確認`,
          status: "warn"
        });
      }
      if (lowNet.length) {
        issues.push({
          label: "實領低於基本工資",
          detail: `共 ${lowNet.length} 筆需人工覆核`,
          status: "warn"
        });
      }
      if (heavyOvertime.length) {
        issues.push({
          label: "加班時數偏高",
          detail: `${heavyOvertime[0].employeeName} 等 ${heavyOvertime.length} 人`,
          status: "warn"
        });
      }
      if (!issues.length) {
        issues.push({
          label: "未偵測到異常",
          detail: "可進入下一步",
          status: "ok"
        });
      }
      return issues;
    };

    /**
     * Build settlement gating flags for the flow.
     * @param {{status: string}[]} checks
     * @param {{status: string}[]} sources
     * @returns {{hasBlock: boolean, isConfirmed: boolean, isCalculated: boolean, canConfirm: boolean, canCalculate: boolean, canComplete: boolean}}
     */
    const buildSettlementGateState = (checks, sources = []) => {
      const hasBlock = [...checks, ...sources].some((item) => item.status === "block");
      const isConfirmed = Boolean(state.settlement.confirmedAt) && !state.settlement.needsConfirm;
      const isCalculated = Boolean(state.settlement.calculatedAt) && !state.settlement.needsRecalc;
      const isLocked = state.settlement.lock;
      return {
        hasBlock,
        isConfirmed,
        isCalculated,
        canConfirm: !hasBlock && !isLocked,
        canCalculate: isConfirmed && !isLocked,
        canComplete: isCalculated && !isLocked
      };
    };

    const generateIdNumber = (gender) => {
      const letter = randomChoice(idLetters);
      const firstDigit = gender === "M" ? "1" : "2";
      const rest = padNumber(randomInt(0, 99999999), 8);
      return `${letter}${firstDigit}${rest}`;
    };

    const createEmployee = (index) => {
      const baseSalary = randomInt(28000, 62000);
      const supervisorAllowance = Math.random() > 0.75 ? randomInt(2000, 6000) : 0;
      const attendanceBonus = Math.random() > 0.2 ? randomInt(800, 2000) : 0;
      const allowances = {
        meal: randomInt(1500, 3000),
        supervisor: supervisorAllowance,
        professional: randomInt(1000, 4000),
        transport: randomInt(500, 2000),
        attendance: attendanceBonus
      };
      const dependents = randomInt(0, 3);
      const gender = Math.random() > 0.5 ? "M" : "F";
      const birthDate = dayjs().subtract(randomInt(22, 58), "year").subtract(randomInt(0, 364), "day");
      const hireDate = dayjs().subtract(randomInt(30, 1500), "day");
      const probationStart = hireDate;
      const probationEnd = hireDate.add(3, "month").subtract(1, "day");
      const department = randomChoice(departments);
      const nationalityCode = Math.random() > 0.85 ? "2" : "1";
      const employmentTypeCode = Math.random() > 0.2 ? "1" : "2";
      const employmentTypeLabel = employmentTypeCode === "1" ? "月薪" : "時薪";
      const employmentStatus = Math.random() > 0.12 ? "在職" : "離職";
      let leaveDate = null;
      if (employmentStatus === "離職") {
        leaveDate = hireDate.add(randomInt(200, 1200), "day");
        if (leaveDate.isAfter(dayjs())) {
          leaveDate = dayjs().subtract(randomInt(1, 180), "day");
        }
      }
      const bankCode = randomChoice(bankCodes);
      const branchCode = `${bankCode}${padNumber(randomInt(0, 9999), 4)}`;
      const account = padNumber(randomInt(0, 99999999999999), 14);
      return {
        employeeId: padNumber(index + 1, 5),
        chineseName: `${randomChoice(surnames)}${randomChoice(nameSeeds)}`,
        englishName: `${randomChoice(englishFirstNames)} ${randomChoice(englishLastNames)}`,
        idNumber: generateIdNumber(gender),
        birthYear: String(birthDate.year()),
        birthMonth: padNumber(birthDate.month() + 1, 2),
        birthDay: padNumber(birthDate.date(), 2),
        age: String(dayjs().diff(birthDate, "year")),
        gender,
        mobile: `09${padNumber(randomInt(0, 99999999), 8)}`,
        phone: `02${padNumber(randomInt(0, 99999999), 8)}`,
        departmentCode: department.code,
        departmentName: department.name,
        jobTitleExternal: randomChoice(jobTitlesExternal),
        jobTitleInternal: randomChoice(jobTitlesInternal),
        jobLevel: String(randomInt(1, 13)),
        note: "到職資料已完成核對",
        education: randomChoice(educations),
        school: randomChoice(schools),
        major: randomChoice(majors),
        hireYear: String(hireDate.year()),
        hireMonth: padNumber(hireDate.month() + 1, 2),
        hireDay: padNumber(hireDate.date(), 2),
        tenureYears: String(Math.max(0, (leaveDate || dayjs()).diff(hireDate, "year"))),
        leaveYear: leaveDate ? String(leaveDate.year()) : "",
        leaveMonth: leaveDate ? padNumber(leaveDate.month() + 1, 2) : "",
        leaveDay: leaveDate ? padNumber(leaveDate.date(), 2) : "",
        badgeCardNumber: padNumber(randomInt(0, 9999999999), 10),
        keyAccess: Math.random() > 0.7 ? "Y" : "N",
        securityAccess: Math.random() > 0.7 ? "Y" : "N",
        bankCode,
        branchCode,
        account,
        probationStart: probationStart.format("YYYY-MM-DD"),
        probationEnd: probationEnd.format("YYYY-MM-DD"),
        nationalityCode,
        employmentTypeCode,
        employmentTypeLabel,
        baseSalary,
        allowances,
        dependentsCount: dependents,
        employmentStatus,
        hireDate: hireDate.format("YYYY-MM-DD"),
        leaveDate: leaveDate ? leaveDate.format("YYYY-MM-DD") : "",
        department: department.name
      };
    };

    /**
     * Build insurance grade data for a specific type.
     * @param {string} type
     * @returns {{code: string, min: number, max: number, insured: number}[]}
     */
    const buildGradeData = (type, versionCode) => {
      const prefix = type === "health" ? "H" : "L";
      return gradeTable.map((item, index) => ({
        code: type === "labor" ? item.code : `${prefix}${padNumber(index + 1, 2)}`,
        min: item.min,
        max: item.max,
        insured: item.insured,
        versionCode
      }));
    };

    /**
     * Return grade list for the specified type.
     * @param {string} type
     * @returns {{code: string, min: number, max: number, insured: number}[]}
     */
    const getGradeData = (type) => {
      const list = state.gradeData?.[type] || [];
      if (list.length) {
        return list;
      }
      const prefix = type === "health" ? "H" : "L";
      const versionCode = state.gradeVersion?.[type]?.activeCode || "";
      return gradeTable.map((item, index) => ({
        code: type === "labor" ? item.code : `${prefix}${padNumber(index + 1, 2)}`,
        min: item.min,
        max: item.max,
        insured: item.insured,
        versionCode
      }));
    };

    /**
     * Build the next grade code based on existing data.
     * @param {string} type
     * @returns {string}
     */
    const getNextGradeCode = (type) => {
      const prefix = type === "health" ? "H" : "L";
      const grades = getGradeData(type);
      const maxValue = grades.reduce((max, item) => {
        const numeric = Number(item.code.replace(prefix, ""));
        return Number.isNaN(numeric) ? max : Math.max(max, numeric);
      }, 0);
      return `${prefix}${padNumber(maxValue + 1, 2)}`;
    };

    /**
     * Get insured salary based on grade ranges.
     * @param {number} salaryBasis
     * @returns {{insuredSalary: number, gradeCode: string}}
     */
    const getInsuredSalary = (salaryBasis) => {
      const gradeList = getGradeData("labor");
      const versionData = state.gradeVersion?.labor;
      const activeVersion = versionData?.versions?.find((item) => item.code === versionData.activeCode && item.status === "啟用");
      const activeGrades = activeVersion ? gradeList.filter((item) => item.versionCode === activeVersion.code) : gradeList;
      const grade = activeGrades.find((item) => salaryBasis >= item.min && salaryBasis <= item.max);
      if (grade) {
        return { insuredSalary: grade.insured, gradeCode: grade.code };
      }
      const last = activeGrades[activeGrades.length - 1] || gradeList[gradeList.length - 1] || gradeTable[gradeTable.length - 1];
      return { insuredSalary: last.insured, gradeCode: last.code };
    };

    const calculatePayroll = (employee, monthLabel) => {
      const allowancesTotal = getAllowanceTotal(employee.allowances);
      const overtimeHours = randomInt(0, 16);
      const hourlyRate = employee.baseSalary / 30 / 8;
      const overtimePay = Math.round((Math.min(overtimeHours, 2) * 1.34 + Math.max(0, overtimeHours - 2) * 1.67) * hourlyRate);
      const grossSalary = employee.baseSalary + allowancesTotal + overtimePay;
      const insuredBase = employee.baseSalary + allowancesTotal;
      const { insuredSalary, gradeCode } = getInsuredSalary(insuredBase);
      const laborPremiumTotal = Math.round(insuredSalary * rules.laborRate);
      const laborEmployee = Math.round(laborPremiumTotal * rules.laborShare.employee);
      const dependents = Math.min(employee.dependentsCount, rules.maxDependents);
      const healthMultiplier = 1 + dependents;
      const healthPremiumTotal = Math.round(insuredSalary * rules.healthRate * healthMultiplier);
      const healthEmployee = Math.round(healthPremiumTotal * rules.healthShare.employee);
      const netSalary = grossSalary - laborEmployee - healthEmployee;
      return {
        payrollId: `P${monthLabel.replace("-", "")}-${employee.employeeId}`,
        employeeName: employee.chineseName,
        employeeId: employee.employeeId,
        grossSalary,
        insuredSalary,
        gradeCode,
        laborEmployee,
        healthEmployee,
        netSalary,
        overtimeHours,
        allowancesTotal,
        department: employee.departmentName,
        status: Math.random() > 0.15 ? "已結算" : "待結算"
      };
    };

    const generateInsuranceVersions = () => [
      { type: "勞保", code: "L2024-01", effectiveDate: "2024-01-01", status: "啟用" },
      { type: "健保", code: "H2024-01", effectiveDate: "2024-01-01", status: "啟用" }
    ];

    const generateInsuranceRates = () => [
      { type: "勞保", rate: "12%", employee: "20%", employer: "70%", government: "10%" },
      { type: "健保", rate: "5.17%", employee: "30%", employer: "60%", government: "10%" }
    ];

    /**
     * Get report month for filtering.
     * @param {{createdAt: string}} report
     * @returns {string}
     */
    const getReportMonth = (report) => dayjs(report.createdAt).format("YYYY-MM");

    /**
     * Sort reports by created time descending.
     * @param {object[]} list
     * @returns {object[]}
     */
    const sortReportsDesc = (list) => [...list].sort((a, b) => b.createdAt.localeCompare(a.createdAt));

    /**
     * Generate report history across multiple months.
     * @param {object[]} employees
     * @returns {object[]}
     */
    const generateReportHistory = (employees) => {
      const history = [];
      const months = 10;
      for (let i = 0; i < months; i += 1) {
        const month = dayjs().subtract(i, "month");
        const monthLabel = month.format("YYYYMM");
        const baseTime = month.endOf("month").hour(18).minute(30);
        history.push({
          reportId: `RPT-${monthLabel}-SUM`,
          type: "薪資總表",
          format: "XLSX",
          createdAt: baseTime.format("YYYY-MM-DD HH:mm"),
          status: "已完成"
        });
        const employee = employees[i % employees.length];
        history.push({
          reportId: `RPT-${monthLabel}-PS-${employee.employeeId}`,
          type: `個人薪資單：${employee.chineseName}`,
          format: "PDF",
          createdAt: baseTime.subtract(2, "hour").format("YYYY-MM-DD HH:mm"),
          status: "已完成"
        });
      }
      return sortReportsDesc(history);
    };

    /**
     * Populate report month filter options.
     * @returns {void}
     */
    const populateReportMonthOptions = () => {
      const select = document.getElementById("reportMonthFilter");
      if (!select) {
        return;
      }
      const months = Array.from(new Set(state.reportHistory.map((report) => getReportMonth(report))))
        .sort((a, b) => b.localeCompare(a));
      const options = [
        `<option value="all">全部月份</option>`,
        ...months.map((month) => `<option value="${month}">${month}</option>`)
      ];
      select.innerHTML = options.join("");
      select.value = state.reportFilterMonth || "all";
    };

    /**
     * Render report filter summary.
     * @returns {void}
     */
    const renderReportFilterSummary = () => {
      const summary = document.getElementById("reportFilterSummary");
      if (!summary) {
        return;
      }
      const label = state.reportFilterMonth === "all" ? "全部月份" : state.reportFilterMonth;
      summary.textContent = `顯示 ${label}，共 ${state.reports.length} 筆`;
    };

    /**
     * Ensure report filter includes the given report.
     * @param {{createdAt: string}} report
     * @returns {void}
     */
    const ensureReportFilterForReport = (report) => {
      if (!report) {
        return;
      }
      const reportMonth = getReportMonth(report);
      if (state.reportFilterMonth !== "all" && state.reportFilterMonth !== reportMonth) {
        state.reportFilterMonth = reportMonth;
      }
      const select = document.getElementById("reportMonthFilter");
      if (select) {
        select.value = state.reportFilterMonth || "all";
      }
    };

    /**
     * Apply report month filter to report list.
     * @returns {void}
     */
    const applyReportFilter = () => {
      const source = sortReportsDesc(state.reportHistory);
      if (state.reportFilterMonth && state.reportFilterMonth !== "all") {
        state.reports = source.filter((report) => getReportMonth(report) === state.reportFilterMonth);
      } else {
        state.reports = source;
      }
      renderReports();
      renderReportNotice(state.reports[0]);
      renderReportDetail(state.reports[0]);
      renderReportFilterSummary();
      renderSettlementDashboard();
    };

    const generateMonthlyHistory = (months, baseGross, baseDeduction) => {
      const history = [];
      for (let i = months - 1; i >= 0; i -= 1) {
        const month = dayjs().subtract(i, "month").format("YYYY-MM");
        const grossFactor = 0.92 + Math.random() * 0.16;
        const deductionFactor = 0.92 + Math.random() * 0.16;
        const grossTotal = Math.round(baseGross * grossFactor);
        const deductionTotal = Math.round(baseDeduction * deductionFactor);
        const netTotal = Math.max(0, grossTotal - deductionTotal);
        history.push({ month, grossTotal, deductionTotal, netTotal });
      }
      return history;
    };

    const updateMonthlyHistory = () => {
      const baseGross = state.payrolls.reduce((sum, item) => sum + item.grossSalary, 0);
      const baseDeduction = state.payrolls.reduce((sum, item) => sum + item.laborEmployee + item.healthEmployee, 0);
      const months = state.historyRange;
      state.monthlyHistory = generateMonthlyHistory(months, baseGross || 1, baseDeduction || 1);
    };

    const generateActivities = () => {
      const now = dayjs();
      return [
        { text: "完成 2024-09 薪資結算", time: now.subtract(2, "hour").format("MM/DD HH:mm") },
        { text: "更新健保版本 H2024-01", time: now.subtract(5, "hour").format("MM/DD HH:mm") },
        { text: "新增員工資料：專案助理", time: now.subtract(1, "day").format("MM/DD HH:mm") }
      ];
    };

    const renderSummary = () => {
      const onDutyEmployees = state.employees.filter((item) => item.employmentStatus === "在職");
      const onDutyMaleCount = onDutyEmployees.filter((item) => item.gender === "M").length;
      const onDutyFemaleCount = onDutyEmployees.filter((item) => item.gender === "F").length;
      const totalGross = state.payrolls.reduce((sum, item) => sum + item.grossSalary, 0);
      const totalNet = state.payrolls.reduce((sum, item) => sum + item.netSalary, 0);
      const laborTotal = state.payrolls.reduce((sum, item) => sum + item.laborEmployee, 0);
      const healthTotal = state.payrolls.reduce((sum, item) => sum + item.healthEmployee, 0);
      const summaryCards = document.getElementById("summaryCards");
      summaryCards.innerHTML = `
        <div class="stat-card">
          <div class="stat-card__label">本月在職人數</div>
          <div class="stat-card__value">${formatter.format(onDutyEmployees.length)} 人</div>
          <div class="stat-card__note">男 ${formatter.format(onDutyMaleCount)} 人 / 女 ${formatter.format(onDutyFemaleCount)} 人</div>
        </div>
        <div class="stat-card" data-permission="payroll.view" data-rbac-silent="true">
          <div class="stat-card__label">本月應發總額</div>
          <div class="stat-card__value">${currency.format(totalGross)}</div>
          <div class="stat-card__note">含本薪 + 津貼 + 加班</div>
        </div>
        <div class="stat-card" data-permission="payroll.view" data-rbac-silent="true">
          <div class="stat-card__label">本月實領總額</div>
          <div class="stat-card__value">${currency.format(totalNet)}</div>
          <div class="stat-card__note">扣除勞保/健保</div>
        </div>
        <div class="stat-card" data-permission="payroll.view" data-rbac-silent="true">
          <div class="stat-card__label">保險扣款合計</div>
          <div class="stat-card__value">${currency.format(laborTotal + healthTotal)}</div>
          <div class="stat-card__note">僅計員工負擔額</div>
        </div>
      `;

      document.getElementById("overviewCards").innerHTML = `
        <div class="card">
          <div class="card__title">薪資結算完成率</div>
          <div class="card__body">本月已結算 ${state.payrolls.filter((item) => item.status === "已結算").length} 筆，待結算 ${state.payrolls.filter((item) => item.status === "待結算").length} 筆。</div>
        </div>
        <div class="card">
          <div class="card__title">勞保與健保扣款</div>
          <div class="card__body">勞保扣款 ${currency.format(laborTotal)}，健保扣款 ${currency.format(healthTotal)}，符合分攤比例。</div>
        </div>
        <div class="card">
          <div class="card__title">勞退提繳</div>
          <div class="card__body">雇主提繳預估 ${currency.format(Math.round(totalGross * rules.pensionEmployerRate))}，不影響員工實領。</div>
        </div>
      `;

      document.getElementById("overviewChips").innerHTML = `
        <span class="chip">最低工資 ${currency.format(rules.minWage)}</span>
        <span class="chip">勞保費率 ${rules.laborRate * 100}%</span>
        <span class="chip">健保費率 ${rules.healthRate * 100}%</span>
      `;

      const costSummary = document.getElementById("costSummary");
      costSummary.innerHTML = `
        <p>勞保與健保均依投保薪資級距計算，員工負擔額已自薪資扣除。</p>
        <p>勞退提繳採雇主 6% 計算，費用將列入雇主成本。</p>
      `;
    };

    const renderEmployees = () => {
      const rows = state.employees
        .map((employee) => {
          const nationalityLabel = employee.nationalityCode === "1" ? "本國" : "外國";
          return `
            <tr>
              <td>${employee.employeeId}</td>
              <td>${employee.chineseName}</td>
              <td>${employee.englishName}</td>
              <td>${employee.departmentCode} ${employee.departmentName}</td>
              <td>${employee.jobTitleInternal}</td>
              <td>${employee.jobLevel}</td>
              <td>${nationalityLabel}</td>
              <td><span class="badge ${employee.employmentStatus === "在職" ? "badge--active" : "badge--warning"}">${employee.employmentStatus}</span></td>
              <td>${employee.hireDate}</td>
              <td>
                <button
                  class="btn btn--ghost"
                  data-action="view-employee"
                  data-employee-id="${employee.employeeId}"
                  data-employee-name="${employee.chineseName}"
                  data-permission="employees.view"
                >查看</button>
                <button
                  class="btn btn--ghost"
                  data-action="edit-employee"
                  data-employee-id="${employee.employeeId}"
                  data-employee-name="${employee.chineseName}"
                  data-permission="employees.edit"
                >編輯</button>
              </td>
            </tr>
          `;
        })
        .join("");
      document.getElementById("employeeTable").innerHTML = rows;
      renderEmployeeSettlementCheck();
      renderSalaryStructure();
      applyRbacToElements();
    };

    /**
     * Render salary structure overview and table data.
     * @returns {void}
     */
    const renderSalaryStructure = () => {
      const summary = document.getElementById("salaryStructureSummary");
      const changeList = document.getElementById("salaryStructureChangeList");
      const table = document.getElementById("salaryStructureTable");
      const note = document.getElementById("salaryStructureNoteBody");
      if (!summary || !changeList || !table) {
        return;
      }

      refreshSettlementData();
      const totalEmployees = state.employees.length;
      const baseTotal = state.employees.reduce((sum, employee) => sum + employee.baseSalary, 0);
      const allowanceTotals = state.employees.reduce((sum, employee) => {
        const allowances = getAllowanceBreakdown(employee.allowances);
        sum.meal += allowances.meal;
        sum.supervisor += allowances.supervisor;
        sum.professional += allowances.professional;
        sum.transport += allowances.transport;
        sum.attendance += allowances.attendance;
        return sum;
      }, { meal: 0, supervisor: 0, professional: 0, transport: 0, attendance: 0 });
      const allowanceTotal = allowanceTotals.meal
        + allowanceTotals.supervisor
        + allowanceTotals.professional
        + allowanceTotals.transport
        + allowanceTotals.attendance;
      const avgBase = totalEmployees ? Math.round(baseTotal / totalEmployees) : 0;
      const avgAllowance = totalEmployees ? Math.round(allowanceTotal / totalEmployees) : 0;
      const avgMeal = totalEmployees ? Math.round(allowanceTotals.meal / totalEmployees) : 0;
      const avgSupervisor = totalEmployees ? Math.round(allowanceTotals.supervisor / totalEmployees) : 0;
      const avgProfessional = totalEmployees ? Math.round(allowanceTotals.professional / totalEmployees) : 0;
      const avgTransport = totalEmployees ? Math.round(allowanceTotals.transport / totalEmployees) : 0;
      const avgAttendance = totalEmployees ? Math.round(allowanceTotals.attendance / totalEmployees) : 0;
      const baseRange = state.employees.reduce(
        (range, employee) => ({
          min: Math.min(range.min, employee.baseSalary),
          max: Math.max(range.max, employee.baseSalary)
        }),
        { min: Number.POSITIVE_INFINITY, max: 0 }
      );
      const salaryChangeCount = Math.min(state.settlementData.salaryChangeCount || 0, totalEmployees);

      summary.innerHTML = `
        <div class="card__title">薪資結構摘要</div>
        <div class="card__body">
          <div>適用員工：${formatter.format(totalEmployees)} 人</div>
          <div>平均本薪：${currency.format(avgBase)} / 津貼合計：${currency.format(avgAllowance)}</div>
          <div class="list__meta">伙食費 ${currency.format(avgMeal)} / 主管津貼 ${currency.format(avgSupervisor)} / 專業津貼 ${currency.format(avgProfessional)}</div>
          <div class="list__meta">交通津貼 ${currency.format(avgTransport)} / 全勤 ${currency.format(avgAttendance)}</div>
          <div>本薪範圍：${currency.format(baseRange.min === Number.POSITIVE_INFINITY ? 0 : baseRange.min)} ～ ${currency.format(baseRange.max)}</div>
          <div class="list__meta">${salaryChangeCount ? `薪資異動 ${salaryChangeCount} 筆待覆核` : "目前無待覆核異動"}</div>
        </div>
      `;

      if (!salaryChangeCount) {
        changeList.innerHTML = `
          <li class="list__item">
            <div>
              <div>未偵測到異動</div>
              <div class="list__meta">可直接進入結薪資料確認</div>
            </div>
            <span class="badge badge--active">正常</span>
          </li>
        `;
      } else {
        const changeEmployees = state.employees.slice(0, salaryChangeCount);
        changeList.innerHTML = changeEmployees
          .map((employee) => {
            const allowances = getAllowanceBreakdown(employee.allowances);
            const allowancesTotal = allowances.meal
              + allowances.supervisor
              + allowances.professional
              + allowances.transport
              + allowances.attendance;
            return `
              <li class="list__item">
                <div>
                  <div>${employee.chineseName} (${employee.employeeId})</div>
                  <div class="list__meta">本薪 ${currency.format(employee.baseSalary)} / 伙食費 ${currency.format(allowances.meal)} / 主管津貼 ${currency.format(allowances.supervisor)}</div>
                  <div class="list__meta">專業津貼 ${currency.format(allowances.professional)} / 交通津貼 ${currency.format(allowances.transport)} / 全勤 ${currency.format(allowances.attendance)} / 合計 ${currency.format(allowancesTotal)}</div>
                </div>
                <span class="badge badge--pending">待覆核</span>
              </li>
            `;
          })
          .join("");
      }

      const changeSet = new Set(state.employees.slice(0, salaryChangeCount).map((employee) => employee.employeeId));
      table.innerHTML = state.employees
        .map((employee, index) => {
          const allowances = getAllowanceBreakdown(employee.allowances);
          const allowancesTotal = allowances.meal
            + allowances.supervisor
            + allowances.professional
            + allowances.transport
            + allowances.attendance;
          const employmentTypeLabel = employee.employmentTypeCode === "2" ? "時薪" : "月薪";
          const isPending = changeSet.has(employee.employeeId);
          const statusLabel = isPending ? "覆核中" : "啟用";
          const statusClass = isPending ? "badge--pending" : "badge--active";
          const effectiveDate = dayjs().subtract(index + 1, "day").format("YYYY-MM-DD");
          return `
            <tr>
              <td>${employee.employeeId}</td>
              <td>${employee.chineseName}</td>
              <td>${employee.departmentCode} ${employee.departmentName}</td>
              <td>${employmentTypeLabel}</td>
              <td>${currency.format(employee.baseSalary)}</td>
              <td>${currency.format(allowances.meal)}</td>
              <td>${currency.format(allowances.supervisor)}</td>
              <td>${currency.format(allowances.professional)}</td>
              <td>${currency.format(allowances.transport)}</td>
              <td>${currency.format(allowances.attendance)}</td>
              <td>${currency.format(allowancesTotal)}</td>
              <td>${effectiveDate}</td>
              <td><span class="badge ${statusClass}">${statusLabel}</span></td>
              <td>
                <button
                  class="btn btn--ghost"
                  data-action="adjust-salary"
                  data-employee-id="${employee.employeeId}"
                  data-employee-name="${employee.chineseName}"
                  data-permission="payroll.edit"
                >調整</button>
              </td>
            </tr>
          `;
        })
        .join("");

      if (note) {
        const updatedAt = state.settlementData.sourceUpdatedAt?.salaryStructure;
        note.textContent = updatedAt ? `最後更新 ${formatDateTime(updatedAt)}，異動後需重新確認結薪作業。` : "尚未更新薪資結構。";
      }
      applyRbacToElements();
    };

    /**
     * Update salary structure detail header based on mode.
     * @param {string} mode
     * @param {object|null} employee
     * @returns {void}
     */
    const setSalaryStructureMeta = (mode, employee) => {
      const title = document.getElementById("salaryStructureTitle");
      const desc = document.getElementById("salaryStructureDesc");
      const submitButton = document.getElementById("submitSalaryStructure");
      if (!title || !submitButton) {
        return;
      }
      const name = employee?.chineseName || "";
      if (mode === "create") {
        title.textContent = "建立薪資結構";
        if (desc) {
          desc.textContent = `為 ${name || "指定員工"} 建立薪資結構，設定身分別、本薪與津貼項目。`;
        }
        submitButton.textContent = "建立薪資結構";
      } else {
        title.textContent = "薪資結構明細";
        if (desc) {
          desc.textContent = `調整 ${name || "指定員工"} 的薪資結構，更新後需重新結薪確認。`;
        }
        submitButton.textContent = "儲存調整";
      }
    };

    /**
     * Toggle salary structure form fields by permission.
     * @param {boolean} canEdit
     * @returns {void}
     */
    const setSalaryStructureFormEditable = (canEdit) => {
      document.querySelectorAll("#salaryStructureFormFields .salary-structure-input").forEach((input) => {
        input.disabled = !canEdit;
      });
    };

    /**
     * Get current salary structure form values.
     * @returns {{employeeId: string, employmentTypeCode: string, baseSalary: number, allowances: object, effectiveDate: string, reason: string}}
     */
    const getSalaryStructureFormValues = () => {
      const parseAmount = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
      };
      const employeeId = document.getElementById("salaryEmployeeSelect")?.value || "";
      const employmentTypeCode = document.getElementById("salaryEmploymentTypeSelect")?.value || "1";
      const baseSalary = parseAmount(document.getElementById("salaryBaseInput")?.value);
      const allowances = {
        meal: parseAmount(document.getElementById("salaryMealInput")?.value),
        supervisor: parseAmount(document.getElementById("salarySupervisorInput")?.value),
        professional: parseAmount(document.getElementById("salaryProfessionalInput")?.value),
        transport: parseAmount(document.getElementById("salaryTransportInput")?.value),
        attendance: parseAmount(document.getElementById("salaryAttendanceInput")?.value)
      };
      const effectiveDate = document.getElementById("salaryEffectiveDateInput")?.value || "";
      const reason = document.getElementById("salaryReasonInput")?.value.trim() || "";
      return { employeeId, employmentTypeCode, baseSalary, allowances, effectiveDate, reason };
    };

    /**
     * Update salary structure preview based on form inputs.
     * @param {string} note
     * @returns {void}
     */
    const updateSalaryStructurePreview = (note) => {
      const preview = document.getElementById("salaryStructurePreview");
      if (!preview) {
        return;
      }
      const values = getSalaryStructureFormValues();
      const employmentTypeLabel = values.employmentTypeCode === "2" ? "時薪" : "月薪";
      const allowancesTotal = getAllowanceTotal(values.allowances);
      const insuredInfo = getInsuredSalary(values.baseSalary + allowancesTotal);
      preview.innerHTML = `
        <div class="card__title">試算摘要</div>
        <div class="card__body">
          <div>身分別：${employmentTypeLabel}</div>
          <div>本薪：${currency.format(values.baseSalary)}</div>
          <div>津貼合計：${currency.format(allowancesTotal)}</div>
          <div>投保薪資級距：${insuredInfo.gradeCode}（${currency.format(insuredInfo.insuredSalary)}）</div>
          <div class="list__meta">${note || "調整內容將同步更新結薪計算。"} </div>
        </div>
      `;
    };

    /**
     * Render salary structure detail panel.
     * @param {object|null} employee
     * @param {string} note
     * @returns {void}
     */
    const renderSalaryStructureDetail = (employee, note) => {
      const target = document.getElementById("salaryStructureTarget");
      const preview = document.getElementById("salaryStructurePreview");
      const form = document.getElementById("salaryStructureForm");
      const detailNote = document.getElementById("salaryStructureDetailNoteBody");
      if (!target || !preview || !form) {
        return;
      }
      const targetEmployee = employee
        || state.employees.find((item) => item.employeeId === state.salaryStructureEditingId)
        || state.employees[0];
      if (!targetEmployee) {
        target.innerHTML = `
          <div class="card__title">適用對象</div>
          <div class="card__body">尚未選擇薪資結構對象。</div>
        `;
        preview.innerHTML = `
          <div class="card__title">試算摘要</div>
          <div class="card__body">尚未載入薪資結構試算。</div>
        `;
        form.innerHTML = `
          <div class="card__title">薪資結構設定</div>
          <div class="card__body">尚未載入薪資結構設定。</div>
        `;
        if (detailNote) {
          detailNote.textContent = "請先選擇薪資結構對象。";
        }
        return;
      }

      state.salaryStructureEditingId = targetEmployee.employeeId;
      const allowances = getAllowanceBreakdown(targetEmployee.allowances);
      const allowancesTotal = getAllowanceTotal(targetEmployee.allowances);
      const insuredInfo = getInsuredSalary(targetEmployee.baseSalary + allowancesTotal);
      const employmentTypeCode = targetEmployee.employmentTypeCode || "1";
      const employmentTypeLabel = employmentTypeCode === "2" ? "時薪" : "月薪";
      const changeCount = Math.min(state.settlementData.salaryChangeCount || 0, state.employees.length);
      const changeSet = new Set(state.employees.slice(0, changeCount).map((item) => item.employeeId));
      const statusLabel = changeSet.has(targetEmployee.employeeId) ? "覆核中" : "啟用";
      const statusClass = changeSet.has(targetEmployee.employeeId) ? "badge--pending" : "badge--active";
      const employeeOptions = state.employees
        .map((item) => {
          const selected = item.employeeId === targetEmployee.employeeId ? "selected" : "";
          return `<option value="${item.employeeId}" ${selected}>${item.employeeId} ${item.chineseName}</option>`;
        })
        .join("");

      target.innerHTML = `
        <div class="card__title">適用對象</div>
        <div class="card__body">
          <div>員工：${targetEmployee.chineseName} (${targetEmployee.employeeId})</div>
          <div>部門：${targetEmployee.departmentCode} ${targetEmployee.departmentName}</div>
          <div>身分別：${employmentTypeLabel}</div>
          <div>在職狀態：${targetEmployee.employmentStatus}</div>
          <div class="list__meta">狀態：<span class="badge ${statusClass}">${statusLabel}</span></div>
        </div>
      `;

      preview.innerHTML = `
        <div class="card__title">試算摘要</div>
        <div class="card__body">
          <div>身分別：${employmentTypeLabel}</div>
          <div>本薪：${currency.format(targetEmployee.baseSalary)}</div>
          <div>津貼合計：${currency.format(allowancesTotal)}</div>
          <div>投保薪資級距：${insuredInfo.gradeCode}（${currency.format(insuredInfo.insuredSalary)}）</div>
          <div class="list__meta">${note || "調整內容將同步更新結薪計算。"} </div>
        </div>
      `;

      form.innerHTML = `
        <div class="card__title">薪資結構設定</div>
        <form class="employee-form" id="salaryStructureFormFields">
          <div class="form-grid">
            <label class="form-field">
              <span class="form-label">員工</span>
              <select class="form-input" id="salaryEmployeeSelect">${employeeOptions}</select>
              <span class="form-hint">選擇要建立/調整的員工</span>
            </label>
            <label class="form-field">
              <span class="form-label">身分別</span>
              <select class="form-input salary-structure-input" id="salaryEmploymentTypeSelect" required>
                <option value="1" ${employmentTypeCode === "1" ? "selected" : ""}>月薪</option>
                <option value="2" ${employmentTypeCode === "2" ? "selected" : ""}>時薪</option>
              </select>
              <span class="form-hint">月薪 / 時薪</span>
            </label>
            <label class="form-field">
              <span class="form-label">本薪</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salaryBaseInput" type="number" min="${rules.minWage}" step="100" value="${targetEmployee.baseSalary}" required />
              <span class="form-hint">不得低於基本工資 ${currency.format(rules.minWage)}</span>
            </label>
            <label class="form-field">
              <span class="form-label">伙食費</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salaryMealInput" type="number" min="0" step="100" value="${allowances.meal}" />
              <span class="form-hint">津貼項目</span>
            </label>
            <label class="form-field">
              <span class="form-label">主管津貼</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salarySupervisorInput" type="number" min="0" step="100" value="${allowances.supervisor}" />
              <span class="form-hint">津貼項目</span>
            </label>
            <label class="form-field">
              <span class="form-label">專業津貼</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salaryProfessionalInput" type="number" min="0" step="100" value="${allowances.professional}" />
              <span class="form-hint">津貼項目</span>
            </label>
            <label class="form-field">
              <span class="form-label">交通津貼</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salaryTransportInput" type="number" min="0" step="100" value="${allowances.transport}" />
              <span class="form-hint">津貼項目</span>
            </label>
            <label class="form-field">
              <span class="form-label">全勤</span>
              <input class="form-input salary-structure-input form-input--align-right" id="salaryAttendanceInput" type="number" min="0" step="100" value="${allowances.attendance}" />
              <span class="form-hint">津貼項目</span>
            </label>
            <label class="form-field">
              <span class="form-label">生效日</span>
              <input class="form-input salary-structure-input" id="salaryEffectiveDateInput" type="date" value="${dayjs().format("YYYY-MM-DD")}" />
              <span class="form-hint">預設當日生效</span>
            </label>
            <label class="form-field">
              <span class="form-label">調整原因</span>
              <textarea class="form-input salary-structure-input" id="salaryReasonInput" maxlength="60"></textarea>
              <span class="form-hint">文字 60 字元</span>
            </label>
          </div>
        </form>
      `;

      if (detailNote) {
        const updatedAt = state.settlementData.sourceUpdatedAt?.salaryStructure;
        detailNote.textContent = updatedAt ? `最後更新 ${formatDateTime(updatedAt)}，調整後需重新結薪確認。` : "尚未產生薪資結構異動。";
      }
      setSalaryStructureFormEditable(hasPermission("payroll.edit"));
      applyRbacToElements();
    };

    /**
     * Collect and validate salary structure form values.
     * @returns {object|null}
     */
    const collectSalaryStructureFormData = () => {
      const values = getSalaryStructureFormValues();
      if (!values.employeeId) {
        showToast("請選擇員工");
        return null;
      }
      if (!values.baseSalary || values.baseSalary < rules.minWage) {
        showToast(`本薪不得低於基本工資 ${currency.format(rules.minWage)}`);
        return null;
      }
      const hasNegative = Object.values(values.allowances).some((value) => value < 0);
      if (hasNegative) {
        showToast("津貼金額不可為負數");
        return null;
      }
      return values;
    };

    /**
     * Open salary structure detail page.
     * @param {object|null} employee
     * @param {string} mode
     * @param {string} note
     * @returns {void}
     */
    const openSalaryStructureDetail = (employee, mode, note) => {
      const targetEmployee = employee || state.employees[0];
      if (!targetEmployee) {
        showToast("尚無員工資料");
        return;
      }
      state.salaryStructureMode = mode || "edit";
      state.salaryStructureEditingId = targetEmployee.employeeId;
      renderSalaryStructureDetail(targetEmployee, note);
      setSalaryStructureMeta(state.salaryStructureMode, targetEmployee);
      openPage("salary-structure-detail", "薪資結構明細", true, false);
    };

    const renderEmployeePreview = (employee, note) => {
      const preview = document.getElementById("employeePreview");
      if (!preview) {
        return;
      }
      if (!employee) {
        preview.innerHTML = `
          <div class="card__title">人事資料摘要</div>
          <div class="card__body">點選「查看」或「新增員工」以顯示資料摘要。</div>
        `;
        return;
      }
      const nationalityLabel = employee.nationalityCode === "1" ? "本國" : "外國";
      preview.innerHTML = `
        <div class="card__title">人事資料摘要</div>
        <div class="card__body">
          <div>員工：${employee.chineseName} / ${employee.englishName} (${employee.employeeId})</div>
          <div>身分證字號：${employee.idNumber} ・ 性別：${employee.gender} ・ 年齡：${employee.age}</div>
          <div>生日：${employee.birthYear}-${employee.birthMonth}-${employee.birthDay}</div>
          <div>部門：${employee.departmentCode} ${employee.departmentName} ・ 職等：${employee.jobLevel}</div>
          <div>對內職稱：${employee.jobTitleInternal} ・ 對外職稱：${employee.jobTitleExternal}</div>
          <div>國別：${nationalityLabel}</div>
          <div>到職日：${employee.hireDate} ・ 試用期：${employee.probationStart} ～ ${employee.probationEnd}</div>
          <div class="list__meta">${note || "資料供流程參考，實際依申報資料為準。"}</div>
        </div>
      `;
      applyRbacToElements();
    };

    /**
     * Render settlement readiness card on employee page.
     * @returns {void}
     */
    const renderEmployeeSettlementCheck = () => {
      const container = document.getElementById("employeeSettlementCheck");
      if (!container) {
        return;
      }
      refreshSettlementData();
      const issueCount = state.settlementData.employeeIssueCount;
      const personnelChangeCount = state.settlementData.personnelChangeCount;
      const issueStatus = issueCount >= 3 ? "block" : issueCount > 0 ? "warn" : "ok";
      const changeStatus = personnelChangeCount ? "warn" : "ok";
      const issueBadge = getStatusBadge(issueStatus);
      const changeBadge = getStatusBadge(changeStatus);
      const updatedAt = state.settlementData.sourceUpdatedAt?.employees;
      const updatedText = updatedAt ? `最後更新 ${formatDateTime(updatedAt)}` : "尚未更新";
      container.innerHTML = `
        <div class="card__title">結薪檢核</div>
        <ul class="list">
          <li class="list__item">
            <div>
              <div>資料完整度</div>
              <div class="list__meta">${issueCount ? `待補 ${issueCount} 筆（帳務/到離職）` : "資料完整"}</div>
            </div>
            <span class="badge ${issueBadge.className}">${issueBadge.label}</span>
          </li>
          <li class="list__item">
            <div>
              <div>人事異動彙整</div>
              <div class="list__meta">${personnelChangeCount ? `本月 ${personnelChangeCount} 筆到離職需覆核` : "未偵測到異動"}</div>
            </div>
            <span class="badge ${changeBadge.className}">${changeBadge.label}</span>
          </li>
        </ul>
        <div class="panel__note">
          <div class="list__meta">${updatedText}</div>
          <div class="list__meta">資料異動後需回到結薪作業重新確認。</div>
        </div>
        <div class="demo__actions">
          <button class="btn btn--ghost btn--tiny" data-nav="settlement" data-label="結薪作業" data-permission="settlement.view">前往結薪作業</button>
        </div>
      `;
    };

    /**
     * Normalize input to digits only.
     * @param {string} value
     * @returns {string}
     */
    const normalizeDigits = (value) => String(value || "").replace(/\D/g, "");

    /**
     * Pad numeric string to the target length with leading zeros.
     * @param {string} value
     * @param {number} length
     * @returns {string}
     */
    const padDigits = (value, length) => {
      const digits = normalizeDigits(value);
      if (!digits) {
        return "";
      }
      if (digits.length >= length) {
        return digits.slice(0, length);
      }
      return digits.padStart(length, "0");
    };

    /**
     * Build a Dayjs date from separate year/month/day strings.
     * @param {string} year
     * @param {string} month
     * @param {string} day
     * @returns {object|null}
     */
    const buildDateFromParts = (year, month, day) => {
      if (!year || !month || !day) {
        return null;
      }
      const date = dayjs(`${year}-${month}-${day}`);
      return date.isValid() ? date : null;
    };

    /**
     * Update derived form fields such as age, tenure, and probation dates.
     * @returns {void}
     */
    const updateEmployeeCreateDerivedFields = () => {
      const birthYear = document.getElementById("birthYearInput")?.value.trim();
      const birthMonth = document.getElementById("birthMonthInput")?.value.trim();
      const birthDay = document.getElementById("birthDayInput")?.value.trim();
      const hireYear = document.getElementById("hireYearInput")?.value.trim();
      const hireMonth = document.getElementById("hireMonthInput")?.value.trim();
      const hireDay = document.getElementById("hireDayInput")?.value.trim();
      const leaveYear = document.getElementById("leaveYearInput")?.value.trim();
      const leaveMonth = document.getElementById("leaveMonthInput")?.value.trim();
      const leaveDay = document.getElementById("leaveDayInput")?.value.trim();

      const birthDate = buildDateFromParts(birthYear, birthMonth, birthDay);
      const hireDate = buildDateFromParts(hireYear, hireMonth, hireDay);
      const leaveDate = leaveYear && leaveMonth && leaveDay ? buildDateFromParts(leaveYear, leaveMonth, leaveDay) : null;

      const ageInput = document.getElementById("ageInput");
      if (ageInput) {
        ageInput.value = birthDate ? String(dayjs().diff(birthDate, "year")) : "";
      }
      const tenureInput = document.getElementById("tenureInput");
      if (tenureInput) {
        tenureInput.value = hireDate ? String(Math.max(0, (leaveDate || dayjs()).diff(hireDate, "year"))) : "";
      }
      const probationStartInput = document.getElementById("probationStartInput");
      const probationEndInput = document.getElementById("probationEndInput");
      if (hireDate && probationStartInput && probationEndInput) {
        const start = hireDate.format("YYYY-MM-DD");
        const end = hireDate.add(3, "month").subtract(1, "day").format("YYYY-MM-DD");
        probationStartInput.value = start.replaceAll("-", "");
        probationEndInput.value = end.replaceAll("-", "");
      } else if (probationStartInput && probationEndInput) {
        probationStartInput.value = "";
        probationEndInput.value = "";
      }
    };

    /**
     * Bind input handlers for the employee create/edit form.
     * @returns {void}
     */
    const bindEmployeeCreateFormHandlers = () => {
      const form = document.getElementById("employeeCreateFormFields");
      if (!form) {
        return;
      }
      form.addEventListener("input", () => {
        updateEmployeeCreateDerivedFields();
      });
      form.querySelectorAll("[data-pad-length]").forEach((input) => {
        input.addEventListener("blur", () => {
          const length = Number(input.dataset.padLength);
          if (!length) {
            return;
          }
          const padded = padDigits(input.value, length);
          input.value = padded;
        });
      });
      form.querySelectorAll("[data-uppercase]").forEach((input) => {
        input.addEventListener("blur", () => {
          input.value = input.value.toUpperCase();
        });
      });
      updateEmployeeCreateDerivedFields();
    };

    /**
     * Collect and validate employee form data.
     * @param {object|null} baseEmployee
     * @returns {object|null}
     */
    const collectEmployeeFormData = (baseEmployee = null) => {
      const form = document.getElementById("employeeCreateFormFields");
      if (!form) {
        return null;
      }
      form.querySelectorAll("[data-pad-length]").forEach((input) => {
        const length = Number(input.dataset.padLength);
        if (length) {
          input.value = padDigits(input.value, length);
        }
      });
      form.querySelectorAll("[data-uppercase]").forEach((input) => {
        input.value = input.value.toUpperCase();
      });
      updateEmployeeCreateDerivedFields();
      if (!form.checkValidity()) {
        form.reportValidity();
        return null;
      }

      const getValue = (id) => document.getElementById(id)?.value.trim() || "";
      const birthYear = getValue("birthYearInput");
      const birthMonth = getValue("birthMonthInput");
      const birthDay = getValue("birthDayInput");
      const hireYear = getValue("hireYearInput");
      const hireMonth = getValue("hireMonthInput");
      const hireDay = getValue("hireDayInput");
      const leaveYear = getValue("leaveYearInput");
      const leaveMonth = getValue("leaveMonthInput");
      const leaveDay = getValue("leaveDayInput");
      const leaveParts = [leaveYear, leaveMonth, leaveDay].filter(Boolean).length;
      if (leaveParts > 0 && leaveParts < 3) {
        showToast("離職日期需填寫完整年月日");
        return null;
      }

      const birthDate = buildDateFromParts(birthYear, birthMonth, birthDay);
      if (!birthDate) {
        showToast("生日日期格式錯誤");
        return null;
      }
      const hireDate = buildDateFromParts(hireYear, hireMonth, hireDay);
      if (!hireDate) {
        showToast("到職日期格式錯誤");
        return null;
      }
      const leaveDate = leaveParts === 3 ? buildDateFromParts(leaveYear, leaveMonth, leaveDay) : null;
      if (leaveParts === 3 && !leaveDate) {
        showToast("離職日期格式錯誤");
        return null;
      }
      if (leaveDate && hireDate && leaveDate.isBefore(hireDate)) {
        showToast("離職日不可早於到職日");
        return null;
      }

      const employeeId = getValue("employeeIdInput");
      const chineseName = getValue("chineseNameInput");
      const englishName = getValue("englishNameInput");
      const idNumber = getValue("idNumberInput");
      const gender = getValue("genderSelect");
      const nationalityCode = getValue("nationalitySelect");
      const mobile = getValue("mobileInput");
      const phone = getValue("phoneInput");
      const departmentCode = getValue("departmentCodeInput");
      const departmentName = getValue("departmentNameInput");
      const jobTitleExternal = getValue("jobTitleExternalInput");
      const jobTitleInternal = getValue("jobTitleInternalInput");
      const jobLevel = getValue("jobLevelSelect");
      const education = getValue("educationInput");
      const school = getValue("schoolInput");
      const major = getValue("majorInput");
      const badgeCardNumber = getValue("badgeCardInput");
      const keyAccess = getValue("keySelect");
      const securityAccess = getValue("securitySelect");
      const bankCode = getValue("bankCodeInput");
      const branchCode = getValue("branchCodeInput");
      const account = getValue("accountInput");
      const note = getValue("noteInput");

      const age = String(dayjs().diff(birthDate, "year"));
      const tenureYears = String(Math.max(0, (leaveDate || dayjs()).diff(hireDate, "year")));
      const probationStart = hireDate.format("YYYY-MM-DD");
      const probationEnd = hireDate.add(3, "month").subtract(1, "day").format("YYYY-MM-DD");
      const employmentStatus = leaveDate ? "離職" : "在職";

      const safeBase = baseEmployee || state.pendingEmployee || createEmployee(state.employees.length);
      const employmentTypeCode = baseEmployee?.employmentTypeCode || safeBase.employmentTypeCode || "1";
      const employmentTypeLabel = employmentTypeCode === "1" ? "月薪" : "時薪";
      return {
        employeeId,
        chineseName,
        englishName,
        idNumber,
        birthYear,
        birthMonth,
        birthDay,
        age,
        gender,
        mobile,
        phone,
        departmentCode,
        departmentName,
        jobTitleExternal,
        jobTitleInternal,
        jobLevel,
        note,
        education,
        school,
        major,
        hireYear,
        hireMonth,
        hireDay,
        tenureYears,
        leaveYear: leaveDate ? leaveYear : "",
        leaveMonth: leaveDate ? leaveMonth : "",
        leaveDay: leaveDate ? leaveDay : "",
        badgeCardNumber,
        keyAccess,
        securityAccess,
        bankCode,
        branchCode,
        account,
        probationStart,
        probationEnd,
        nationalityCode,
        employmentTypeCode,
        employmentTypeLabel,
        baseSalary: safeBase.baseSalary,
        allowances: safeBase.allowances,
        dependentsCount: safeBase.dependentsCount,
        employmentStatus,
        hireDate: hireDate.format("YYYY-MM-DD"),
        leaveDate: leaveDate ? leaveDate.format("YYYY-MM-DD") : "",
        department: departmentName
      };
    };

    /**
     * Render the employee create/edit form.
     * @param {object|null} employee
     * @returns {void}
     */
    const renderEmployeeCreate = (employee) => {
      const form = document.getElementById("employeeCreateForm");
      if (!form) {
        return;
      }
      const isEditMode = state.employeeFormMode === "edit";
      const cardTitle = isEditMode ? "員工資料編輯" : "員工新增申請表";
      if (!employee) {
        const emptyMessage = isEditMode ? "尚未載入可編輯的員工資料。" : "尚未產生待新增的員工資料。";
        form.innerHTML = `
          <div class="card__title">${cardTitle}</div>
          <div class="card__body">${emptyMessage}</div>
        `;
        return;
      }
      const nationalityCode = employee.nationalityCode || "1";
      const gender = employee.gender || "M";
      const jobLevel = employee.jobLevel || "1";
      const probationStartCompact = employee.probationStart ? employee.probationStart.replaceAll("-", "") : "";
      const probationEndCompact = employee.probationEnd ? employee.probationEnd.replaceAll("-", "") : "";
      const departmentCodeOptions = departments
        .map((dept) => `<option value="${dept.code}">${dept.name}</option>`)
        .join("");
      const departmentNameOptions = departments.map((dept) => `<option value="${dept.name}"></option>`).join("");
      const jobTitleExternalOptions = jobTitlesExternal.map((title) => `<option value="${title}"></option>`).join("");
      const jobTitleInternalOptions = jobTitlesInternal.map((title) => `<option value="${title}"></option>`).join("");
      const educationOptions = educations.map((item) => `<option value="${item}"></option>`).join("");
      const schoolOptions = schools.map((item) => `<option value="${item}"></option>`).join("");
      const majorOptions = majors.map((item) => `<option value="${item}"></option>`).join("");
      const jobLevelOptions = Array.from({ length: 13 }, (_, index) => {
        const value = String(index + 1);
        return `<option value="${value}" ${value === jobLevel ? "selected" : ""}>${value}</option>`;
      }).join("");

      form.innerHTML = `
        <div class="card__title">${cardTitle}</div>
        <form class="employee-form" id="employeeCreateFormFields">
          <div class="form-section">
            <div class="form-section__title">基本資料</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">員工編號</span>
                <input
                  class="form-input"
                  id="employeeIdInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="5"
                  pattern="\\d{5}"
                  data-pad-length="5"
                  value="${employee.employeeId || ""}"
                  required
                />
                <span class="form-hint">5 碼，不足補 0</span>
              </label>
              <label class="form-field">
                <span class="form-label">中文名字</span>
                <input class="form-input" id="chineseNameInput" type="text" maxlength="12" value="${employee.chineseName || ""}" required />
                <span class="form-hint">文字 12 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">英文名字</span>
                <input class="form-input" id="englishNameInput" type="text" maxlength="20" value="${employee.englishName || ""}" required />
                <span class="form-hint">文字 20 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">身分證字號</span>
                <input
                  class="form-input form-input--uppercase"
                  id="idNumberInput"
                  type="text"
                  maxlength="10"
                  pattern="[A-Z][0-9]{9}"
                  data-uppercase
                  value="${employee.idNumber || ""}"
                  required
                />
                <span class="form-hint">1 英文 + 9 數字</span>
              </label>
              <label class="form-field">
                <span class="form-label">性別</span>
                <select class="form-input" id="genderSelect" required>
                  <option value="M" ${gender === "M" ? "selected" : ""}>M</option>
                  <option value="F" ${gender === "F" ? "selected" : ""}>F</option>
                </select>
                <span class="form-hint">M / F</span>
              </label>
              <label class="form-field">
                <span class="form-label">國別</span>
                <select class="form-input" id="nationalitySelect" required>
                  <option value="1" ${nationalityCode === "1" ? "selected" : ""}>本國人</option>
                  <option value="2" ${nationalityCode === "2" ? "selected" : ""}>外國人</option>
                </select>
                <span class="form-hint">本國人 / 外國人</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">生日與年齡</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">生日年</span>
                <input class="form-input" id="birthYearInput" type="text" inputmode="numeric" maxlength="4" pattern="\\d{4}" value="${employee.birthYear || ""}" required />
                <span class="form-hint">西元年 4 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">生日月</span>
                <input
                  class="form-input"
                  id="birthMonthInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|1[0-2])"
                  data-pad-length="2"
                  value="${employee.birthMonth || ""}"
                  required
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">生日日</span>
                <input
                  class="form-input"
                  id="birthDayInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|[12][0-9]|3[01])"
                  data-pad-length="2"
                  value="${employee.birthDay || ""}"
                  required
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">年齡</span>
                <input class="form-input" id="ageInput" type="text" value="${employee.age || ""}" readonly />
                <span class="form-hint">系統計算</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">聯絡資訊</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">手機號碼</span>
                <input
                  class="form-input"
                  id="mobileInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="10"
                  pattern="\\d{10}"
                  value="${employee.mobile || ""}"
                  required
                />
                <span class="form-hint">10 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">電話</span>
                <input
                  class="form-input"
                  id="phoneInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="10"
                  pattern="\\d{10}"
                  value="${employee.phone || ""}"
                  required
                />
                <span class="form-hint">10 碼</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">職務資訊</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">部門代碼</span>
                <input
                  class="form-input"
                  id="departmentCodeInput"
                  type="text"
                  maxlength="4"
                  value="${employee.departmentCode || ""}"
                  list="departmentCodeList"
                  required
                />
                <span class="form-hint">4 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">部門名稱</span>
                <input
                  class="form-input"
                  id="departmentNameInput"
                  type="text"
                  maxlength="40"
                  value="${employee.departmentName || ""}"
                  list="departmentNameList"
                  required
                />
                <span class="form-hint">文字 40 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">對外職稱</span>
                <input
                  class="form-input"
                  id="jobTitleExternalInput"
                  type="text"
                  maxlength="20"
                  value="${employee.jobTitleExternal || ""}"
                  list="jobTitleExternalList"
                  required
                />
                <span class="form-hint">文字 20 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">對內職稱</span>
                <input
                  class="form-input"
                  id="jobTitleInternalInput"
                  type="text"
                  maxlength="20"
                  value="${employee.jobTitleInternal || ""}"
                  list="jobTitleInternalList"
                  required
                />
                <span class="form-hint">文字 20 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">職等</span>
                <select class="form-input" id="jobLevelSelect" required>
                  ${jobLevelOptions}
                </select>
                <span class="form-hint">1 至 13</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">學歷資料</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">學歷</span>
                <input class="form-input" id="educationInput" type="text" maxlength="6" value="${employee.education || ""}" list="educationList" required />
                <span class="form-hint">文字 6 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">學校</span>
                <input class="form-input" id="schoolInput" type="text" maxlength="12" value="${employee.school || ""}" list="schoolList" required />
                <span class="form-hint">文字 12 字元</span>
              </label>
              <label class="form-field">
                <span class="form-label">科系</span>
                <input class="form-input" id="majorInput" type="text" maxlength="12" value="${employee.major || ""}" list="majorList" required />
                <span class="form-hint">文字 12 字元</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">到離職與試用期</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">到職年</span>
                <input class="form-input" id="hireYearInput" type="text" inputmode="numeric" maxlength="4" pattern="\\d{4}" value="${employee.hireYear || ""}" required />
                <span class="form-hint">西元年 4 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">到職月</span>
                <input
                  class="form-input"
                  id="hireMonthInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|1[0-2])"
                  data-pad-length="2"
                  value="${employee.hireMonth || ""}"
                  required
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">到職日</span>
                <input
                  class="form-input"
                  id="hireDayInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|[12][0-9]|3[01])"
                  data-pad-length="2"
                  value="${employee.hireDay || ""}"
                  required
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">離職年</span>
                <input class="form-input" id="leaveYearInput" type="text" inputmode="numeric" maxlength="4" pattern="\\d{4}" value="${employee.leaveYear || ""}" />
                <span class="form-hint">西元年 4 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">離職月</span>
                <input
                  class="form-input"
                  id="leaveMonthInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|1[0-2])"
                  data-pad-length="2"
                  value="${employee.leaveMonth || ""}"
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">離職日</span>
                <input
                  class="form-input"
                  id="leaveDayInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="2"
                  pattern="(0[1-9]|[12][0-9]|3[01])"
                  data-pad-length="2"
                  value="${employee.leaveDay || ""}"
                />
                <span class="form-hint">2 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">廣盛年資</span>
                <input class="form-input" id="tenureInput" type="text" value="${employee.tenureYears || ""}" readonly />
                <span class="form-hint">系統計算</span>
              </label>
              <label class="form-field">
                <span class="form-label">試用起日</span>
                <input class="form-input" id="probationStartInput" type="text" value="${probationStartCompact}" readonly />
                <span class="form-hint">到職年月日</span>
              </label>
              <label class="form-field">
                <span class="form-label">試用訖日</span>
                <input class="form-input" id="probationEndInput" type="text" value="${probationEndCompact}" readonly />
                <span class="form-hint">試用起日 + 3 個月 - 1 天</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section__title">識別與帳務</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">識別證卡號</span>
                <input
                  class="form-input"
                  id="badgeCardInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="10"
                  pattern="\\d{10}"
                  data-pad-length="10"
                  value="${employee.badgeCardNumber || ""}"
                  required
                />
                <span class="form-hint">10 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">Key</span>
                <select class="form-input" id="keySelect" required>
                  <option value="Y" ${employee.keyAccess === "Y" ? "selected" : ""}>Y</option>
                  <option value="N" ${employee.keyAccess === "N" ? "selected" : ""}>N</option>
                </select>
                <span class="form-hint">Y / N</span>
              </label>
              <label class="form-field">
                <span class="form-label">保全</span>
                <select class="form-input" id="securitySelect" required>
                  <option value="Y" ${employee.securityAccess === "Y" ? "selected" : ""}>Y</option>
                  <option value="N" ${employee.securityAccess === "N" ? "selected" : ""}>N</option>
                </select>
                <span class="form-hint">Y / N</span>
              </label>
              <label class="form-field">
                <span class="form-label">銀行別</span>
                <input
                  class="form-input"
                  id="bankCodeInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="3"
                  pattern="\\d{3}"
                  data-pad-length="3"
                  value="${employee.bankCode || ""}"
                  required
                />
                <span class="form-hint">3 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">分行別</span>
                <input
                  class="form-input"
                  id="branchCodeInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="7"
                  pattern="\\d{7}"
                  data-pad-length="7"
                  value="${employee.branchCode || ""}"
                  required
                />
                <span class="form-hint">7 碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">帳號</span>
                <input
                  class="form-input form-input--align-right"
                  id="accountInput"
                  type="text"
                  inputmode="numeric"
                  maxlength="14"
                  pattern="\\d{14}"
                  data-pad-length="14"
                  value="${employee.account || ""}"
                  required
                />
                <span class="form-hint">14 碼，不足補 0</span>
              </label>
              <label class="form-field">
                <span class="form-label">備註</span>
                <textarea class="form-input" id="noteInput" maxlength="60">${employee.note || ""}</textarea>
                <span class="form-hint">文字 60 字元</span>
              </label>
            </div>
          </div>

          <datalist id="departmentCodeList">${departmentCodeOptions}</datalist>
          <datalist id="departmentNameList">${departmentNameOptions}</datalist>
          <datalist id="jobTitleExternalList">${jobTitleExternalOptions}</datalist>
          <datalist id="jobTitleInternalList">${jobTitleInternalOptions}</datalist>
          <datalist id="educationList">${educationOptions}</datalist>
          <datalist id="schoolList">${schoolOptions}</datalist>
          <datalist id="majorList">${majorOptions}</datalist>
        </form>
      `;
      bindEmployeeCreateFormHandlers();
    };

    /**
     * Update employee form header and action button by mode.
     * @param {string} mode
     * @param {object|null} employee
     * @returns {void}
     */
    const setEmployeeFormMeta = (mode, employee) => {
      const title = document.getElementById("employeeFormTitle");
      const desc = document.getElementById("employeeFormDesc");
      const submitButton = document.getElementById("submitEmployeeCreate");
      if (!title || !submitButton) {
        return;
      }
      if (mode === "edit") {
        title.textContent = "編輯員工";
        if (desc) {
          desc.textContent = `編輯 ${employee?.chineseName || ""} 的員工資料，欄位規範依人事資料結構。`;
        }
        submitButton.textContent = "儲存變更";
      } else {
        title.textContent = "新增員工";
        if (desc) {
          desc.textContent = "填寫員工基本資料、職務資訊與帳務資料，欄位規範依人事資料結構。";
        }
        submitButton.textContent = "送出新增";
      }
    };

    const renderEmployeeDetail = (employee) => {
      const detail = document.getElementById("employeeDetailBody");
      const payrollCard = document.getElementById("employeeDetailPayroll");
      if (!detail || !payrollCard) {
        return;
      }
      if (!employee) {
        detail.innerHTML = `
          <div class="card__title">員工資料</div>
          <div class="card__body">尚未選擇員工。</div>
        `;
        payrollCard.innerHTML = `
          <div class="card__title">最新薪資摘要</div>
          <div class="card__body">尚未載入薪資資訊。</div>
        `;
        applyRbacToElements();
        return;
      }
      const allowances = getAllowanceBreakdown(employee.allowances);
      const allowancesTotal = allowances.meal
        + allowances.supervisor
        + allowances.professional
        + allowances.transport
        + allowances.attendance;
      const insuredBasis = employee.baseSalary + allowancesTotal;
      const insuredInfo = getInsuredSalary(insuredBasis);
      const nationalityLabel = employee.nationalityCode === "1" ? "本國" : "外國";
      detail.innerHTML = `
        <div class="card__title">員工資料</div>
        <div class="card__body">
          <div>員工：${employee.chineseName} / ${employee.englishName} (${employee.employeeId})</div>
          <div>身分證字號：${employee.idNumber} ・ 性別：${employee.gender} ・ 年齡：${employee.age}</div>
          <div>生日：${employee.birthYear}-${employee.birthMonth}-${employee.birthDay}</div>
          <div>手機號碼：${employee.mobile} ・ 電話：${employee.phone}</div>
          <div>部門：${employee.departmentCode} ${employee.departmentName}</div>
          <div>對外職稱：${employee.jobTitleExternal} ・ 對內職稱：${employee.jobTitleInternal}</div>
          <div>職等：${employee.jobLevel} ・ 國別：${nationalityLabel}</div>
          <div>學歷：${employee.education} ・ 學校：${employee.school} ・ 科系：${employee.major}</div>
          <div>在職狀態：${employee.employmentStatus}</div>
          <div>年資：${employee.tenureYears} 年</div>
          <div>到職日：${employee.hireDate} ・ 試用起訖：${employee.probationStart} ～ ${employee.probationEnd}</div>
          <div>離職日：${employee.leaveDate || "—"}</div>
          <div data-permission="payroll.view" data-rbac-label="薪資結構">
            <div>本薪：${currency.format(employee.baseSalary)}</div>
            <div>伙食費 ${currency.format(allowances.meal)} / 主管津貼 ${currency.format(allowances.supervisor)} / 專業津貼 ${currency.format(allowances.professional)}</div>
            <div>交通津貼 ${currency.format(allowances.transport)} / 全勤 ${currency.format(allowances.attendance)} / 津貼合計 ${currency.format(allowancesTotal)}</div>
            <div>投保薪資：${currency.format(insuredInfo.insuredSalary)}（級距 ${insuredInfo.gradeCode}）</div>
            <div>眷屬數：${Math.min(employee.dependentsCount, rules.maxDependents)} 人</div>
          </div>
          <div>識別證卡號：${employee.badgeCardNumber} ・ Key：${employee.keyAccess} ・ 保全：${employee.securityAccess}</div>
          <div>銀行別：${employee.bankCode} ・ 分行別：${employee.branchCode} ・ 帳號：${employee.account}</div>
          <div>備註：${employee.note}</div>
        </div>
      `;

      const payroll = state.payrolls.find((item) => item.employeeId === employee.employeeId);
      if (!payroll) {
        payrollCard.innerHTML = `
          <div class="card__title">最新薪資摘要</div>
          <div class="card__body">尚未產生薪資資料。</div>
        `;
        applyRbacToElements();
        return;
      }
      payrollCard.innerHTML = `
        <div class="card__title">最新薪資摘要</div>
        <div class="card__body">
          <div>薪資編號：${payroll.payrollId}</div>
          <div>應發：${currency.format(payroll.grossSalary)}</div>
          <div>實領：${currency.format(payroll.netSalary)}</div>
          <div>勞保扣款：${currency.format(payroll.laborEmployee)}</div>
          <div>健保扣款：${currency.format(payroll.healthEmployee)}</div>
          <div>狀態：${payroll.status}</div>
        </div>
      `;
      applyRbacToElements();
    };

    const renderInsurance = () => {
      document.getElementById("versionTable").innerHTML = state.insuranceVersions
        .map((item) => `
          <tr>
            <td>${item.type}</td>
            <td>${item.code}</td>
            <td>${item.effectiveDate}</td>
            <td><span class="badge badge--active">${item.status}</span></td>
          </tr>
        `)
        .join("");

      const laborGrades = getGradeData("labor");
      const laborVersion = state.gradeVersion?.labor;
      const activeLabor = laborVersion?.versions?.find((item) => item.code === laborVersion.activeCode && item.status === "啟用");
      const displayGrades = activeLabor ? laborGrades.filter((item) => item.versionCode === activeLabor.code) : laborGrades;

      document.getElementById("gradeTable").innerHTML = displayGrades.slice(0, 8)
        .map((item) => `
          <tr>
            <td>${item.code}</td>
            <td>${currency.format(item.min)} ～ ${currency.format(item.max)}</td>
            <td>${currency.format(item.insured)}</td>
          </tr>
        `)
        .join("");

      document.getElementById("rateTable").innerHTML = state.insuranceRates
        .map((item) => `
          <tr>
            <td>${item.type}</td>
            <td>${item.rate}</td>
            <td>${item.employee}</td>
            <td>${item.employer}</td>
            <td>${item.government}</td>
          </tr>
        `)
        .join("");

      renderInsuranceSettlementCheck();
      applyRbacToElements();
    };

    /**
     * Render settlement readiness card on insurance page.
     * @returns {void}
     */
    const renderInsuranceSettlementCheck = () => {
      const container = document.getElementById("insuranceSettlementCheck");
      if (!container) {
        return;
      }
      const labor = state.insuranceVersions.find((item) => item.type === "勞保");
      const health = state.insuranceVersions.find((item) => item.type === "健保");
      const hasInsurance = Boolean(labor && health);
      const hasActiveGrade = Boolean(state.gradeVersion?.labor?.activeCode && state.gradeVersion?.health?.activeCode);
      const versionBadge = getStatusBadge(hasInsurance ? "ok" : "block");
      const gradeBadge = getStatusBadge(hasActiveGrade ? "ok" : "block");
      const updatedAt = state.settlementData.sourceUpdatedAt?.insurance;
      const updatedText = updatedAt ? `最後更新 ${formatDateTime(updatedAt)}` : "尚未更新";
      container.innerHTML = `
        <div class="card__title">結薪檢核</div>
        <ul class="list">
          <li class="list__item">
            <div>
              <div>保險版本</div>
              <div class="list__meta">${hasInsurance ? `${labor.code} / ${health.code}` : "尚未啟用保險版本"}</div>
            </div>
            <span class="badge ${versionBadge.className}">${versionBadge.label}</span>
          </li>
          <li class="list__item">
            <div>
              <div>投保級距版本</div>
              <div class="list__meta">${
                hasActiveGrade
                  ? `勞保 ${state.gradeVersion.labor.activeCode} / 健保 ${state.gradeVersion.health.activeCode}`
                  : "尚未設定啟用級距版本"
              }</div>
            </div>
            <span class="badge ${gradeBadge.className}">${gradeBadge.label}</span>
          </li>
        </ul>
        <div class="panel__note">
          <div class="list__meta">${updatedText}</div>
          <div class="list__meta">版本調整後需回到結薪作業重新確認。</div>
        </div>
        <div class="demo__actions">
          <button class="btn btn--ghost btn--tiny" data-nav="settlement" data-label="結薪作業" data-permission="settlement.view">前往結薪作業</button>
        </div>
      `;
    };

    /**
     * Render grade version list and status for the specified insurance type.
     * @param {string} type
     * @returns {void}
     */
    const renderGradeVersion = (type) => {
      const container = document.getElementById(`${type}GradeVersion`);
      if (!container) {
        return;
      }
      const versionData = state.gradeVersion?.[type] || { activeCode: null, versions: [] };
      const typeLabel = type === "labor" ? "勞保" : "健保";
      const activeVersion = versionData.versions.find((item) => item.code === versionData.activeCode);
      const activeCode = activeVersion ? activeVersion.code : "未啟用";
      const activeDate = activeVersion ? activeVersion.effectiveDate : "-";
      const activeStatus = activeVersion ? activeVersion.status : "停用";
      const activeStatusClass = activeStatus === "啟用" ? "badge--active" : "badge--pending";
      const rows = versionData.versions.length
        ? versionData.versions
          .map((item) => {
            const statusClass = item.status === "啟用" ? "badge--active" : "badge--pending";
            const actionLabel = item.status === "啟用" ? "停用版本" : "啟用版本";
            const actionType = item.status === "啟用" ? "deactivate" : "activate";
            return `
              <tr>
                <td>${item.code}</td>
                <td>${item.effectiveDate}</td>
                <td><span class="badge ${statusClass}">${item.status}</span></td>
                <td>
                  <button class="btn btn--soft" data-grade-version-action="${actionType}" data-grade-type="${type}" data-grade-code="${item.code}" data-permission="insurance.edit">
                    ${actionLabel}
                  </button>
                </td>
              </tr>
            `;
          })
          .join("")
        : `
          <tr>
            <td colspan="4">尚未建立版本代碼。</td>
          </tr>
        `;
      container.innerHTML = `
        <div class="card__title">${typeLabel}級距版本代碼</div>
        <div class="card__body">
          <div>${typeLabel}目前版本：${activeCode}</div>
          <div>生效日：${activeDate}</div>
          <div>版本狀態：<span class="badge ${activeStatusClass}">${activeStatus}</span></div>
          <div class="demo__actions grade-version__actions">
            <button class="btn btn--soft" data-grade-version-action="create" data-grade-type="${type}" data-permission="insurance.edit">新增版本代碼</button>
          </div>
          <table class="table grade-version__table">
            <thead>
              <tr>
                <th>版本代碼</th>
                <th>生效日</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
      applyRbacToElements();
    };

    /**
     * Render grade maintenance table for the specified insurance type.
     * @param {string} type
     * @returns {void}
     */
    const renderGradeTable = (type) => {
      const table = document.getElementById(`${type}GradeTable`);
      if (!table) {
        return;
      }
      table.innerHTML = getGradeData(type)
        .map((item) => `
          <tr>
            <td>${item.code}</td>
            <td>${item.versionCode || "未指定"}</td>
            <td>${currency.format(item.min)} ～ ${currency.format(item.max)}</td>
            <td>${currency.format(item.insured)}</td>
            <td>
              <button class="btn btn--ghost" data-grade-action="view" data-grade-type="${type}" data-grade-code="${item.code}" data-permission="insurance.edit">檢視</button>
              <button class="btn btn--ghost" data-grade-action="edit" data-grade-type="${type}" data-grade-code="${item.code}" data-permission="insurance.edit">修改</button>
            </td>
          </tr>
        `)
        .join("");
      applyRbacToElements();
    };

    /**
     * Update grade form state for a specific type.
     * @param {string} type
     * @param {string} mode
     * @param {string|null} code
     * @returns {void}
     */
    const setGradeFormState = (type, mode, code = null) => {
      state.gradeFormState[type] = { mode, code };
      renderGradeForm(type);
    };

    /**
     * Render grade maintenance form in the modal for a specific insurance type.
     * @param {string} type
     * @returns {void}
     */
    const renderGradeForm = (type) => {
      const modal = document.getElementById("gradeModal");
      const container = document.getElementById("gradeModalBody");
      const titleEl = document.getElementById("gradeModalTitle");
      if (!modal || !container || !titleEl) {
        return;
      }
      const formState = state.gradeFormState[type] || { mode: "empty", code: null };
      if (formState.mode === "empty") {
        modal.classList.remove("modal--open");
        modal.setAttribute("aria-hidden", "true");
        modal.removeAttribute("data-grade-type");
        container.innerHTML = "";
        return;
      }
      const grade = formState.code ? getGradeData(type).find((item) => item.code === formState.code) : null;
      const isCreate = formState.mode === "create";
      const isView = formState.mode === "view";
      const prefix = type === "health" ? "H" : "L";
      const versionData = state.gradeVersion?.[type] || { activeCode: null, versions: [] };
      const versionOptions = versionData.versions
        .map((item) => `<option value="${item.code}">${item.code}（${item.effectiveDate}）</option>`)
        .join("");
      const values = grade || {
        code: getNextGradeCode(type),
        min: "",
        max: "",
        insured: "",
        versionCode: versionData.activeCode || (versionData.versions[0]?.code || "")
      };
      const readonlyAttr = isView ? "readonly" : "";
      const disabledAttr = isView ? "disabled" : "";
      const title = isCreate ? "新增級距" : isView ? "級距內容" : "修改級距";
      const actionLabel = isCreate ? "建立級距" : "儲存變更";
      const typeLabel = type === "labor" ? "勞保" : "健保";

      titleEl.textContent = `${typeLabel}${title}`;
      modal.dataset.gradeType = type;
      modal.classList.add("modal--open");
      modal.setAttribute("aria-hidden", "false");

      container.innerHTML = `
        <form class="employee-form">
          <div>
            <p class="form-section__title">${typeLabel}級距基本資料</p>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">級距代碼</span>
                <input class="form-input" id="${type}GradeCode" value="${values.code}" ${readonlyAttr} />
                <span class="form-hint">格式：${prefix}01 ~ ${prefix}99</span>
              </label>
              <label class="form-field">
                <span class="form-label">版本代碼</span>
                ${
                  versionOptions
                    ? `<select class="form-input" id="${type}GradeVersion" ${disabledAttr} required>
                        ${versionOptions}
                      </select>`
                    : `<input class="form-input" id="${type}GradeVersion" value="${values.versionCode}" ${readonlyAttr} />`
                }
                <span class="form-hint">對應級距版本代碼</span>
              </label>
              <label class="form-field">
                <span class="form-label">薪資區間下限</span>
                <input class="form-input" id="${type}GradeMin" type="number" min="0" value="${values.min}" ${readonlyAttr} />
                <span class="form-hint">不得低於基本工資 ${currency.format(rules.minWage)}</span>
              </label>
              <label class="form-field">
                <span class="form-label">薪資區間上限</span>
                <input class="form-input" id="${type}GradeMax" type="number" min="0" value="${values.max}" ${readonlyAttr} />
                <span class="form-hint">上限需大於或等於下限</span>
              </label>
              <label class="form-field">
                <span class="form-label">投保薪資</span>
                <input class="form-input" id="${type}GradeInsured" type="number" min="0" value="${values.insured}" ${readonlyAttr} />
                <span class="form-hint">依投保薪資級距規範填寫</span>
              </label>
            </div>
          </div>
          <div class="demo__actions">
            ${
              isView
                ? `<button class="btn btn--primary" type="button" data-grade-action="edit" data-grade-type="${type}" data-grade-code="${values.code}" data-permission="insurance.edit">修改級距</button>`
                : `<button class="btn btn--primary" type="button" data-grade-action="save" data-grade-type="${type}" data-permission="insurance.edit">${actionLabel}</button>`
            }
            <button class="btn btn--ghost" type="button" data-grade-action="cancel" data-grade-type="${type}">返回清單</button>
          </div>
        </form>
      `;
      const versionSelect = document.getElementById(`${type}GradeVersion`);
      if (versionSelect && values.versionCode) {
        versionSelect.value = values.versionCode;
      }
      applyRbacToElements();
    };

    /**
     * Save grade form values into the state.
     * @param {string} type
     * @returns {void}
     */
    const saveGradeForm = (type) => {
      const formState = state.gradeFormState[type];
      const codeInput = document.getElementById(`${type}GradeCode`);
      const versionInput = document.getElementById(`${type}GradeVersion`);
      const minInput = document.getElementById(`${type}GradeMin`);
      const maxInput = document.getElementById(`${type}GradeMax`);
      const insuredInput = document.getElementById(`${type}GradeInsured`);
      if (!formState || !codeInput || !versionInput || !minInput || !maxInput || !insuredInput) {
        return;
      }
      const code = codeInput.value.trim().toUpperCase();
      const versionCode = versionInput.value.trim().toUpperCase();
      const min = Number(minInput.value);
      const max = Number(maxInput.value);
      const insured = Number(insuredInput.value);
      const typeLabel = type === "labor" ? "勞保" : "健保";
      const versionData = state.gradeVersion?.[type] || { versions: [] };

      if (!code) {
        showToast("請填寫級距代碼");
        return;
      }
      if (!versionCode) {
        showToast("請選擇版本代碼");
        return;
      }
      if (!versionData.versions.some((item) => item.code === versionCode)) {
        showToast("版本代碼不存在");
        return;
      }
      if (Number.isNaN(min) || Number.isNaN(max) || Number.isNaN(insured)) {
        showToast("請填寫完整的薪資級距數值");
        return;
      }
      if (min < rules.minWage) {
        showToast(`薪資下限不得低於基本工資 ${currency.format(rules.minWage)}`);
        return;
      }
      if (min > max) {
        showToast("薪資下限不可高於上限");
        return;
      }
      if (insured < min || insured > max) {
        showToast("投保薪資需落在薪資區間內");
        return;
      }

      const nextGrade = { code, min, max, insured, versionCode };
      if (formState.mode === "create") {
        if (state.gradeData[type].some((item) => item.code === code)) {
          showToast("級距代碼已存在");
          return;
        }
        state.gradeData[type] = [...state.gradeData[type], nextGrade].sort((a, b) => a.min - b.min);
        setGradeFormState(type, "view", code);
        setAction(`已新增${typeLabel}級距 ${code}`);
        logActivity(`新增${typeLabel}級距：${code}`);
        showToast(`${typeLabel}級距已新增`);
      } else if (formState.mode === "edit") {
        if (code !== formState.code && state.gradeData[type].some((item) => item.code === code)) {
          showToast("級距代碼已存在");
          return;
        }
        state.gradeData[type] = state.gradeData[type]
          .map((item) => (item.code === formState.code ? nextGrade : item))
          .sort((a, b) => a.min - b.min);
        setGradeFormState(type, "view", code);
        setAction(`已更新${typeLabel}級距 ${code}`);
        logActivity(`更新${typeLabel}級距：${code}`);
        showToast(`${typeLabel}級距已更新`);
      }

      touchSettlementSource("insurance");
      renderGradeTable(type);
      renderInsurance();
      updatePayrollAfterGradeChange(`${typeLabel}級距更新後重新計算投保薪資。`);
    };

    /**
     * Build the next grade version code.
     * @param {string} type
     * @returns {string}
     */
    const getNextGradeVersionCode = (type) => {
      const prefix = type === "labor" ? "LG" : "HG";
      const versions = state.gradeVersion?.[type]?.versions || [];
      const currentYear = dayjs().format("YYYY");
      let maxSeq = 0;
      versions.forEach((item) => {
        const match = item.code.match(new RegExp(`^${prefix}(\\d{4})-(\\d{2})$`));
        if (!match || match[1] !== currentYear) {
          return;
        }
        const seq = Number(match[2]);
        if (!Number.isNaN(seq)) {
          maxSeq = Math.max(maxSeq, seq);
        }
      });
      return `${prefix}${currentYear}-${padNumber(maxSeq + 1, 2)}`;
    };

    /**
     * Render grade version form modal.
     * @param {string} type
     * @returns {void}
     */
    const renderGradeVersionForm = (type) => {
      const modal = document.getElementById("gradeVersionModal");
      const container = document.getElementById("gradeVersionModalBody");
      const titleEl = document.getElementById("gradeVersionModalTitle");
      if (!modal || !container || !titleEl) {
        return;
      }
      const typeLabel = type === "labor" ? "勞保" : "健保";
      const prefix = type === "labor" ? "LG" : "HG";
      const defaultCode = getNextGradeVersionCode(type);
      const defaultDate = dayjs().format("YYYY-MM-DD");
      titleEl.textContent = `${typeLabel}級距版本代碼`;
      modal.dataset.gradeType = type;
      modal.classList.add("modal--open");
      modal.setAttribute("aria-hidden", "false");
      container.innerHTML = `
        <form class="employee-form">
          <div class="form-grid">
            <label class="form-field">
              <span class="form-label">版本代碼</span>
              <input
                class="form-input form-input--uppercase"
                id="${type}GradeVersionCode"
                type="text"
                value="${defaultCode}"
                pattern="${prefix}\\d{4}-\\d{2}"
                data-uppercase
                required
              />
              <span class="form-hint">格式：${prefix}YYYY-01</span>
            </label>
            <label class="form-field">
              <span class="form-label">生效日</span>
              <input
                class="form-input"
                id="${type}GradeVersionDate"
                type="text"
                value="${defaultDate}"
                pattern="\\d{4}-\\d{2}-\\d{2}"
                required
              />
              <span class="form-hint">格式：YYYY-MM-DD</span>
            </label>
          </div>
          <div class="demo__actions">
            <button class="btn btn--primary" type="button" data-grade-version-action="save" data-grade-type="${type}" data-permission="insurance.edit">建立版本</button>
            <button class="btn btn--ghost" type="button" data-grade-version-action="cancel">返回清單</button>
          </div>
        </form>
      `;
      applyRbacToElements();
    };

    /**
     * Close the grade version modal.
     * @returns {void}
     */
    const closeGradeVersionModal = () => {
      const modal = document.getElementById("gradeVersionModal");
      const container = document.getElementById("gradeVersionModalBody");
      if (!modal || !container) {
        return;
      }
      modal.classList.remove("modal--open");
      modal.setAttribute("aria-hidden", "true");
      modal.removeAttribute("data-grade-type");
      container.innerHTML = "";
    };

    /**
     * Save grade version form values.
     * @param {string} type
     * @returns {void}
     */
    const saveGradeVersionForm = (type) => {
      const codeInput = document.getElementById(`${type}GradeVersionCode`);
      const dateInput = document.getElementById(`${type}GradeVersionDate`);
      if (!codeInput || !dateInput) {
        return;
      }
      const code = codeInput.value.trim().toUpperCase();
      const effectiveDate = dateInput.value.trim();
      const prefix = type === "labor" ? "LG" : "HG";
      const pattern = new RegExp(`^${prefix}\\d{4}-\\d{2}$`);
      const typeLabel = type === "labor" ? "勞保" : "健保";

      if (!pattern.test(code)) {
        showToast(`版本代碼需為 ${prefix}YYYY-01 格式`);
        return;
      }
      if (!effectiveDate || !dayjs(effectiveDate).isValid()) {
        showToast("請填寫正確的生效日");
        return;
      }

      const versionData = state.gradeVersion?.[type] || { activeCode: null, versions: [] };
      if (versionData.versions.some((item) => item.code === code)) {
        showToast("版本代碼已存在");
        return;
      }

      const nextVersions = [...versionData.versions, { code, effectiveDate, status: "停用" }]
        .sort((a, b) => a.effectiveDate.localeCompare(b.effectiveDate));
      state.gradeVersion[type] = {
        ...versionData,
        versions: nextVersions
      };
      renderGradeVersion(type);
      closeGradeVersionModal();
      touchSettlementSource("insurance");
      renderInsuranceSettlementCheck();
      markSettlementDirty("新增級距版本後需重新確認結薪資料。");
      setAction(`已新增${typeLabel}級距版本 ${code}`);
      logActivity(`新增${typeLabel}級距版本：${code}`);
      showToast(`${typeLabel}級距版本已建立`);
    };

    const renderInsuranceNotice = (note) => {
      const notice = document.getElementById("insuranceNotice");
      if (!notice) {
        return;
      }
      const labor = state.insuranceVersions.find((item) => item.type === "勞保") || { code: "-", effectiveDate: "-" };
      const health = state.insuranceVersions.find((item) => item.type === "健保") || { code: "-", effectiveDate: "-" };
      notice.innerHTML = `
        <div class="card__title">版本狀態</div>
        <div class="card__body">
          <div>勞保版本：${labor.code}（${labor.effectiveDate}）</div>
          <div>健保版本：${health.code}（${health.effectiveDate}）</div>
          <div class="list__meta">${note || "點選「切換啟用版本」可更新版本資料。"} </div>
        </div>
      `;
    };

    const renderInsuranceDetail = (note) => {
      const detail = document.getElementById("insuranceDetailBody");
      const rateDetail = document.getElementById("insuranceDetailRates");
      if (!detail || !rateDetail) {
        return;
      }
      const snapshot = state.insuranceSnapshots || {
        before: state.insuranceVersions,
        after: state.insuranceVersions
      };
      const beforeLabor = snapshot.before.find((item) => item.type === "勞保") || { code: "-", effectiveDate: "-" };
      const beforeHealth = snapshot.before.find((item) => item.type === "健保") || { code: "-", effectiveDate: "-" };
      const afterLabor = snapshot.after.find((item) => item.type === "勞保") || { code: "-", effectiveDate: "-" };
      const afterHealth = snapshot.after.find((item) => item.type === "健保") || { code: "-", effectiveDate: "-" };

      detail.innerHTML = `
        <div class="card__title">版本摘要</div>
        <div class="card__body">
          <div>勞保版本：${beforeLabor.code} → ${afterLabor.code}</div>
          <div>健保版本：${beforeHealth.code} → ${afterHealth.code}</div>
          <div>生效日：${afterLabor.effectiveDate} / ${afterHealth.effectiveDate}</div>
          <div class="list__meta">${note || "版本資料供流程參考。"} </div>
        </div>
      `;

      rateDetail.innerHTML = `
        <div class="card__title">費率資訊</div>
        <div class="card__body">
          ${state.insuranceRates
            .map(
              (rate) =>
                `<div>${rate.type}：費率 ${rate.rate} / 員工 ${rate.employee} / 雇主 ${rate.employer} / 政府 ${rate.government}</div>`
            )
            .join("")}
          <div class="list__meta">費率依台灣制度規則呈現。</div>
        </div>
      `;
    };

    const renderPayroll = () => {
      const rows = state.payrolls
        .map((item) => `
          <tr>
            <td>${item.payrollId}</td>
            <td>${item.employeeName} (${item.employeeId})</td>
            <td>${currency.format(item.grossSalary)}</td>
            <td>${currency.format(item.insuredSalary)}<br /><span class="list__meta">級距 ${item.gradeCode}</span></td>
            <td>${currency.format(item.laborEmployee)}</td>
            <td>${currency.format(item.healthEmployee)}</td>
            <td>${currency.format(item.netSalary)}</td>
            <td><span class="badge ${item.status === "已結算" ? "badge--active" : "badge--pending"}">${item.status}</span></td>
            <td>
              <button class="btn btn--ghost" data-action="view-payroll" data-payroll-id="${item.payrollId}" data-permission="payroll.view">查看</button>
            </td>
          </tr>
        `)
        .join("");
      document.getElementById("payrollTable").innerHTML = rows;
      applyRbacToElements();
    };

    const renderPayrollNotice = (note) => {
      const notice = document.getElementById("payrollNotice");
      if (!notice) {
        return;
      }
      const month = document.getElementById("payrollMonth").value;
      const totalGross = state.payrolls.reduce((sum, item) => sum + item.grossSalary, 0);
      const totalNet = state.payrolls.reduce((sum, item) => sum + item.netSalary, 0);
      const pendingCount = state.payrolls.filter((item) => item.status === "待結算").length;
      notice.innerHTML = `
        <div class="card__title">試算結果摘要</div>
        <div class="card__body">
          <div>試算月份：${month}</div>
          <div>應發總額：${currency.format(totalGross)} / 實領總額：${currency.format(totalNet)}</div>
          <div>待結算筆數：${pendingCount} 筆</div>
          <div class="list__meta">${note || "點選「執行試算」可重新產生加班與保險扣款。"} </div>
        </div>
      `;
    };

    const renderPayrollDetail = (payroll, note) => {
      const detail = document.getElementById("payrollDetailBody");
      const insuranceDetail = document.getElementById("payrollDetailInsurance");
      if (!detail || !insuranceDetail) {
        return;
      }
      if (!payroll) {
        detail.innerHTML = `
          <div class="card__title">薪資明細</div>
          <div class="card__body">尚未選擇薪資資料。</div>
        `;
        insuranceDetail.innerHTML = `
          <div class="card__title">保險扣款與雇主成本</div>
          <div class="card__body">尚未載入保險資訊。</div>
        `;
        return;
      }
      const employee = state.employees.find((item) => item.employeeId === payroll.employeeId);
      const allowances = getAllowanceBreakdown(employee?.allowances);
      const allowancesTotal = allowances.meal
        + allowances.supervisor
        + allowances.professional
        + allowances.transport
        + allowances.attendance;
      const overtimePay = Math.max(0, payroll.grossSalary - (employee ? employee.baseSalary : 0) - allowancesTotal);
      const dependents = employee ? Math.min(employee.dependentsCount, rules.maxDependents) : 0;
      detail.innerHTML = `
        <div class="card__title">薪資明細</div>
        <div class="card__body">
          <div>薪資編號：${payroll.payrollId}</div>
          <div>員工：${payroll.employeeName} (${payroll.employeeId})</div>
          <div>本薪：${employee ? currency.format(employee.baseSalary) : "-"}</div>
          <div>伙食費 ${currency.format(allowances.meal)} / 主管津貼 ${currency.format(allowances.supervisor)} / 專業津貼 ${currency.format(allowances.professional)}</div>
          <div>交通津貼 ${currency.format(allowances.transport)} / 全勤 ${currency.format(allowances.attendance)} / 津貼合計 ${currency.format(allowancesTotal)}</div>
          <div>加班時數：${payroll.overtimeHours} 小時 / 加班費：${currency.format(overtimePay)}</div>
          <div>應發：${currency.format(payroll.grossSalary)}</div>
          <div>實領：${currency.format(payroll.netSalary)}</div>
          <div>狀態：${payroll.status}</div>
          <div class="list__meta">${note || "試算結果供流程參考。"} </div>
        </div>
      `;

      const laborTotal = Math.round(payroll.insuredSalary * rules.laborRate);
      const laborEmployer = Math.round(laborTotal * rules.laborShare.employer);
      const healthTotal = Math.round(payroll.insuredSalary * rules.healthRate * (1 + dependents));
      const healthEmployer = Math.round(healthTotal * rules.healthShare.employer);
      const pensionEmployer = Math.round(payroll.grossSalary * rules.pensionEmployerRate);
      insuranceDetail.innerHTML = `
        <div class="card__title">保險扣款與雇主成本</div>
        <div class="card__body">
          <div>投保薪資：${currency.format(payroll.insuredSalary)}（級距 ${payroll.gradeCode}）</div>
          <div>勞保：員工 ${currency.format(payroll.laborEmployee)} / 雇主 ${currency.format(laborEmployer)}</div>
          <div>健保：員工 ${currency.format(payroll.healthEmployee)} / 雇主 ${currency.format(healthEmployer)}</div>
          <div>勞退雇主提繳：${currency.format(pensionEmployer)}</div>
          <div class="list__meta">眷屬數 ${dependents} 人，健保計算倍數 ${1 + dependents}。</div>
        </div>
      `;
    };

    const renderReports = () => {
      const table = document.getElementById("reportTable");
      if (!table) {
        return;
      }
      const rows = state.reports.length
        ? state.reports
          .map((report) => `
            <tr>
              <td>${report.reportId}</td>
              <td>${report.type}</td>
              <td>${report.format}</td>
              <td>${report.createdAt}</td>
              <td><span class="badge badge--active">${report.status}</span></td>
              <td>
                <button class="btn btn--ghost" data-action="view-report" data-report-id="${report.reportId}" data-permission="reports.view">查看</button>
              </td>
            </tr>
          `)
          .join("")
        : `
          <tr>
            <td colspan="6">尚無符合條件的報表。</td>
          </tr>
        `;
      table.innerHTML = rows;
      applyRbacToElements();
    };

    const renderReportNotice = (report, note) => {
      const notice = document.getElementById("reportNotice");
      if (!notice) {
        return;
      }
      if (!report) {
        notice.innerHTML = `
        <div class="card__title">匯出檔案</div>
        <div class="card__body">尚未產生報表。</div>
      `;
        return;
      }
      const ext = report.format.toLowerCase();
      const fileMonth = dayjs(report.createdAt).format("YYYY-MM");
      notice.innerHTML = `
        <div class="card__title">匯出檔案</div>
        <div class="card__body">
          <div>最新報表：${report.type}</div>
          <div>檔案格式：${report.format} / 產生時間：${report.createdAt}</div>
          <div>檔案路徑：/exports/${fileMonth}/${report.reportId}.${ext}</div>
          <div class="list__meta">${note || "實際檔案以系統輸出為準。"} </div>
        </div>
      `;
    };

    const renderReportDetail = (report, note) => {
      const detail = document.getElementById("reportDetailBody");
      const preview = document.getElementById("reportDetailPreview");
      if (!detail || !preview) {
        return;
      }
      if (!report) {
        detail.innerHTML = `
          <div class="card__title">報表資訊</div>
          <div class="card__body">尚未選擇報表。</div>
        `;
        preview.innerHTML = `
          <div class="card__title">資料預覽</div>
          <div class="card__body">尚未載入資料。</div>
        `;
        return;
      }
      detail.innerHTML = `
        <div class="card__title">報表資訊</div>
        <div class="card__body">
          <div>報表編號：${report.reportId}</div>
          <div>類型：${report.type}</div>
          <div>格式：${report.format}</div>
          <div>產生時間：${report.createdAt}</div>
          <div>狀態：${report.status}</div>
          <div class="list__meta">${note || "報表資料供流程參考。"} </div>
        </div>
      `;

      if (report.type.includes("薪資總表")) {
        const rows = state.payrolls.slice(0, 5)
          .map((item) => `
            <tr>
              <td>${item.employeeId}</td>
              <td>${item.employeeName}</td>
              <td>${currency.format(item.grossSalary)}</td>
              <td>${currency.format(item.netSalary)}</td>
            </tr>
          `)
          .join("");
        preview.innerHTML = `
          <div class="card__title">資料預覽（前 5 筆）</div>
          <table class="table">
            <thead>
              <tr>
                <th>員工編號</th>
                <th>姓名</th>
                <th>應發</th>
                <th>實領</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } else {
        const payroll = state.payrolls.find((item) => report.reportId.includes(item.employeeId)) || state.payrolls[0];
        preview.innerHTML = `
          <div class="card__title">資料預覽</div>
          <div class="card__body">
            <div>員工：${payroll.employeeName} (${payroll.employeeId})</div>
            <div>應發：${currency.format(payroll.grossSalary)}</div>
            <div>實領：${currency.format(payroll.netSalary)}</div>
            <div>勞保扣款：${currency.format(payroll.laborEmployee)}</div>
            <div>健保扣款：${currency.format(payroll.healthEmployee)}</div>
          </div>
        `;
      }
    };

    /**
     * Render settlement dashboard and flow status.
     * @returns {void}
     */
    const renderSettlementDashboard = () => {
      const chipGroup = document.getElementById("settlementChips");
      if (!chipGroup) {
        return;
      }
      const checks = buildSettlementChecks();
      const sources = buildSettlementSources();
      const gate = buildSettlementGateState(checks, sources);
      const totalEmployees = state.employees.length;
      const onDutyCount = state.employees.filter((item) => item.employmentStatus === "在職").length;
      const month = state.settlementData.attendance.month || dayjs().format("YYYY-MM");
      const labor = state.insuranceVersions.find((item) => item.type === "勞保") || { code: "-", effectiveDate: "-" };
      const health = state.insuranceVersions.find((item) => item.type === "健保") || { code: "-", effectiveDate: "-" };
      const overallStatus = state.settlement.lock
        ? "已完成"
        : gate.isCalculated
          ? "待完成"
          : gate.isConfirmed
            ? "待計算"
            : "待確認";

      chipGroup.innerHTML = `
        <span class="chip">計薪月份 ${month}</span>
        <span class="chip">在職 ${onDutyCount}/${totalEmployees} 人</span>
        <span class="chip">結薪狀態 ${overallStatus}</span>
      `;

      const step1Label = gate.isConfirmed
        ? "已確認"
        : state.settlement.needsConfirm && state.settlement.confirmedAt
          ? "需重新確認"
          : gate.hasBlock
            ? "待修正"
            : "待確認";
      const step1Badge = gate.isConfirmed
        ? "badge--active"
        : gate.hasBlock
          ? "badge--warning"
          : "badge--pending";
      const step1Meta = state.settlement.confirmedAt
        ? `上次確認 ${formatDateTime(state.settlement.confirmedAt)}`
        : "尚未完成確認";

      const step2Label = gate.isCalculated
        ? "已計算"
        : state.settlement.needsRecalc && state.settlement.calculatedAt
          ? "需重算"
          : gate.isConfirmed
            ? "待計算"
            : "未確認";
      const step2Badge = gate.isCalculated
        ? "badge--active"
        : state.settlement.needsRecalc && state.settlement.calculatedAt
          ? "badge--warning"
          : gate.isConfirmed
            ? "badge--pending"
            : "badge--warning";
      const step2Meta = state.settlement.calculatedAt
        ? `最後試算 ${formatDateTime(state.settlement.calculatedAt)}`
        : "尚未執行試算";

      const step3Label = state.settlement.lock
        ? "已完成"
        : gate.isCalculated
          ? "待完成"
          : state.settlement.needsRecalc
            ? "待重算"
            : "未計算";
      const step3Badge = state.settlement.lock
        ? "badge--active"
        : gate.isCalculated
          ? "badge--pending"
          : "badge--warning";
      const step3Meta = state.settlement.completedAt
        ? `完成時間 ${formatDateTime(state.settlement.completedAt)}`
        : "尚未完成結薪";

      const step1BadgeEl = document.getElementById("settlementStep1Badge");
      const step1MetaEl = document.getElementById("settlementStep1Meta");
      const step2BadgeEl = document.getElementById("settlementStep2Badge");
      const step2MetaEl = document.getElementById("settlementStep2Meta");
      const step3BadgeEl = document.getElementById("settlementStep3Badge");
      const step3MetaEl = document.getElementById("settlementStep3Meta");
      if (step1BadgeEl && step1MetaEl && step2BadgeEl && step2MetaEl && step3BadgeEl && step3MetaEl) {
        step1BadgeEl.textContent = step1Label;
        step1BadgeEl.className = `badge ${step1Badge}`;
        step1MetaEl.textContent = step1Meta;
        step2BadgeEl.textContent = step2Label;
        step2BadgeEl.className = `badge ${step2Badge}`;
        step2MetaEl.textContent = step2Meta;
        step3BadgeEl.textContent = step3Label;
        step3BadgeEl.className = `badge ${step3Badge}`;
        step3MetaEl.textContent = step3Meta;
      }

      const confirmButton = document.getElementById("settlementConfirm");
      const calculateButton = document.getElementById("settlementCalculate");
      const completeButton = document.getElementById("settlementComplete");
      const reopenButton = document.getElementById("settlementReopen");
      const exportSummaryButton = document.getElementById("settlementExportSummary");
      const exportPayslipButton = document.getElementById("settlementExportPayslip");
      const canEditSettlement = hasPermission("settlement.edit");
      const canExportReports = hasPermission("reports.export");
      if (confirmButton) {
        confirmButton.disabled = !canEditSettlement || !gate.canConfirm;
        confirmButton.textContent = state.settlement.needsConfirm && state.settlement.confirmedAt ? "重新確認" : "完成確認";
      }
      if (calculateButton) {
        calculateButton.disabled = !canEditSettlement || !gate.canCalculate;
        calculateButton.textContent = state.settlement.needsRecalc && state.settlement.calculatedAt ? "重新計算" : "執行計算";
      }
      if (completeButton) {
        completeButton.disabled = !canEditSettlement || !gate.canComplete;
      }
      if (reopenButton) {
        reopenButton.disabled = !canEditSettlement || (!state.settlement.lock && !state.settlement.completedAt);
      }
      const canExport = gate.isCalculated && !state.settlement.needsRecalc && canExportReports;
      if (exportSummaryButton) {
        exportSummaryButton.disabled = !canExport;
      }
      if (exportPayslipButton) {
        exportPayslipButton.disabled = !canExport;
      }

      const dataSummary = document.getElementById("settlementDataSummary");
      const attendance = state.settlementData.attendance;
      const salaryChangeCount = state.settlementData.salaryChangeCount;
      if (dataSummary) {
        dataSummary.innerHTML = `
          <div class="card__title">薪資資料摘要</div>
          <div class="card__body">
            <div>計薪月份：${month}</div>
            <div>試算人數：${totalEmployees} 人（在職 ${onDutyCount}）</div>
            <div>出勤資料：${attendance.imported}/${totalEmployees} 筆，缺漏 ${attendance.missing} 筆</div>
            <div>薪資異動：${salaryChangeCount ? `${salaryChangeCount} 筆需覆核` : "未偵測到異動"}</div>
            <div class="list__meta">資料同步：${attendance.lastSync}</div>
          </div>
        `;
      }

      const checkList = document.getElementById("settlementCheckList");
      if (checkList) {
        checkList.innerHTML = checks
          .map((check) => {
            const badge = getStatusBadge(check.status);
            const actionPermission = check.actionNav ? getPagePermission(check.actionNav) : "";
            const permissionAttr = actionPermission ? `data-permission="${actionPermission}"` : "";
            const actionLabel = check.actionLabel || "前往處理";
            const actionButton = check.actionNav
              ? `<button class="btn btn--ghost btn--tiny" data-nav="${check.actionNav}" data-label="${actionLabel}" data-rbac-label="${actionLabel}" ${permissionAttr}>前往處理</button>`
              : "";
            return `
              <li class="list__item">
                <div>
                  <div>${check.label}</div>
                  <div class="list__meta">${check.detail}</div>
                </div>
                <div class="demo__actions">
                  <span class="badge ${badge.className}">${badge.label}</span>
                  ${actionButton}
                </div>
              </li>
            `;
          })
          .join("");
      }

      const blockList = document.getElementById("settlementBlockList");
      const warnList = document.getElementById("settlementWarnList");
      const blockedItems = checks.filter((item) => item.status === "block");
      const warnItems = checks.filter((item) => item.status === "warn");
      if (blockList) {
        blockList.innerHTML = blockedItems.length
          ? blockedItems
            .map((item) => {
              const badge = getStatusBadge(item.status);
              return `
                <li class="list__item">
                  <div>
                    <div>${item.label}</div>
                    <div class="list__meta">${item.detail}</div>
                  </div>
                  <span class="badge ${badge.className}">${badge.label}</span>
                </li>
              `;
            })
            .join("")
          : `
            <li class="list__item">
              <div>無阻擋項目</div>
              <span class="badge badge--active">OK</span>
            </li>
          `;
      }
      if (warnList) {
        warnList.innerHTML = warnItems.length
          ? warnItems
            .map((item) => {
              const badge = getStatusBadge(item.status);
              return `
                <li class="list__item">
                  <div>
                    <div>${item.label}</div>
                    <div class="list__meta">${item.detail}</div>
                  </div>
                  <span class="badge ${badge.className}">${badge.label}</span>
                </li>
              `;
            })
            .join("")
          : `
            <li class="list__item">
              <div>無警示項目</div>
              <span class="badge badge--active">OK</span>
            </li>
          `;
      }

      const sourceList = document.getElementById("settlementSourceList");
      if (sourceList) {
        sourceList.innerHTML = sources
          .map((source) => {
            const badge = getStatusBadge(source.status);
            const actionPermission = source.actionNav ? getPagePermission(source.actionNav) : "";
            const permissionAttr = actionPermission ? `data-permission="${actionPermission}"` : "";
            const actionLabel = source.actionLabel || "前往處理";
            const actionButton = source.actionNav
              ? `<button class="btn btn--ghost btn--tiny" data-nav="${source.actionNav}" data-label="${actionLabel}" data-rbac-label="${actionLabel}" ${permissionAttr}>前往處理</button>`
              : "";
            return `
              <li class="list__item">
                <div>
                  <div>${source.label}</div>
                  <div class="list__meta">${source.detail}</div>
                  ${source.meta ? `<div class="list__meta">${source.meta}</div>` : ""}
                </div>
                <div class="demo__actions">
                  <span class="badge ${badge.className}">${badge.label}</span>
                  ${actionButton}
                </div>
              </li>
            `;
          })
          .join("");
      }

      const calcSummary = document.getElementById("settlementCalcSummary");
      const totalGross = state.payrolls.reduce((sum, item) => sum + item.grossSalary, 0);
      const totalNet = state.payrolls.reduce((sum, item) => sum + item.netSalary, 0);
      const totalDeduction = state.payrolls.reduce((sum, item) => sum + item.laborEmployee + item.healthEmployee, 0);
      const pendingCount = state.payrolls.filter((item) => item.status === "待結算").length;
      if (calcSummary) {
        calcSummary.innerHTML = `
          <div class="card__title">資料計算摘要</div>
          <div class="card__body">
            <div>計薪月份：${month}</div>
            <div>試算人數：${state.payrolls.length} 人</div>
            <div>應發總額：${currency.format(totalGross)}</div>
            <div>扣款總額：${currency.format(totalDeduction)}</div>
            <div>實領總額：${currency.format(totalNet)}</div>
            <div>待結算：${pendingCount} 筆</div>
            <div class="list__meta">加班規則：前 2 小時 1.34 倍，其後 1.67 倍</div>
          </div>
        `;
      }

      const calcIssues = document.getElementById("settlementCalcIssueList");
      if (calcIssues) {
        const issueList = buildSettlementCalculationIssues();
        calcIssues.innerHTML = issueList
          .map((issue) => {
            const badge = getStatusBadge(issue.status);
            return `
              <li class="list__item">
                <div>
                  <div>${issue.label}</div>
                  <div class="list__meta">${issue.detail}</div>
                </div>
                <span class="badge ${badge.className}">${badge.label}</span>
              </li>
            `;
          })
          .join("");
      }

      const calcSnapshot = document.getElementById("settlementCalcSnapshot");
      if (calcSnapshot) {
        calcSnapshot.innerHTML = `
          <div class="card__title">計算快照</div>
          <div class="card__body">
            <div>最後試算：${state.settlement.calculatedAt ? formatDateTime(state.settlement.calculatedAt) : "尚未試算"}</div>
            <div>投保版本：勞保 ${labor.code} / 健保 ${health.code}</div>
            <div>級距版本：勞保 ${state.gradeVersion?.labor?.activeCode || "-"} / 健保 ${state.gradeVersion?.health?.activeCode || "-"}</div>
            <div class="list__meta">${state.settlement.needsRecalc ? "資料已異動，建議重新計算。" : "試算快照已更新。"}</div>
          </div>
        `;
      }

      const completeSummary = document.getElementById("settlementCompleteSummary");
      if (completeSummary) {
        completeSummary.innerHTML = `
          <div class="card__title">結薪完成狀態</div>
          <div class="card__body">
            <div>結薪狀態：${state.settlement.lock ? "已完成" : "未完成"}</div>
            <div>完成時間：${state.settlement.completedAt ? formatDateTime(state.settlement.completedAt) : "—"}</div>
            <div>鎖定狀態：${state.settlement.lock ? "已鎖定" : "未鎖定"}</div>
            <div>最後試算：${state.settlement.calculatedAt ? formatDateTime(state.settlement.calculatedAt) : "—"}</div>
            <div class="list__meta">結薪完成後若有資料異動需重新開帳。</div>
          </div>
        `;
      }

      const exportNote = document.getElementById("settlementExportNote");
      if (exportNote) {
        if (!canExportReports) {
          exportNote.textContent = "此角色無匯出權限。";
        } else {
          exportNote.textContent = canExport ? "可產生薪資總表與個人薪資單。" : "請完成資料計算後再進行匯出。";
        }
      }

      const reportList = document.getElementById("settlementReportList");
      if (reportList) {
        const recentReports = sortReportsDesc(state.reportHistory).slice(0, 3);
        const reportBody = recentReports.length
          ? `
            <ul class="list">
              ${recentReports
                .map(
                  (report) => `
                    <li class="list__item">
                      <div>
                        <div>${report.type}</div>
                        <div class="list__meta">${report.reportId} ・ ${report.createdAt}</div>
                      </div>
                      <span class="badge badge--active">${report.status}</span>
                    </li>
                  `
                )
                .join("")}
            </ul>
          `
          : `<div class="card__body">尚未產生報表。</div>`;
        reportList.innerHTML = `
          <div class="card__title">最近報表</div>
          ${reportBody}
        `;
      }

      const step2Note = document.getElementById("settlementStep2Note");
      if (step2Note) {
        if (!canEditSettlement) {
          step2Note.textContent = "此角色僅可檢視結薪流程，無法執行計算。";
        } else if (state.settlement.lock) {
          step2Note.textContent = "結薪已完成，請重新開帳後再試算。";
        } else if (!gate.isConfirmed) {
          step2Note.textContent = "請先完成資料確認。";
        } else if (state.settlement.needsRecalc) {
          step2Note.textContent = "資料已異動，請重新計算後再進入下一步。";
        } else {
          step2Note.textContent = "資料計算完成，可進入下一步。";
        }
      }

      const step3Note = document.getElementById("settlementStep3Note");
      if (step3Note) {
        if (!canEditSettlement) {
          step3Note.textContent = "此角色僅可檢視結薪流程，無法完成結薪。";
        } else if (state.settlement.lock) {
          step3Note.textContent = "結薪流程已鎖定，需重新開帳才能調整資料。";
        } else if (!gate.isCalculated) {
          step3Note.textContent = "請完成資料計算後再結薪。";
        } else {
          step3Note.textContent = "請確認報表資訊後完成結薪。";
        }
      }

      const step2Card = document.getElementById("settlementStep2");
      const step3Card = document.getElementById("settlementStep3");
      if (step2Card) {
        step2Card.classList.toggle("step-card--disabled", !canEditSettlement || (!gate.canCalculate && !gate.isCalculated));
      }
      if (step3Card) {
        step3Card.classList.toggle("step-card--disabled", !canEditSettlement || (!gate.canComplete && !state.settlement.lock));
      }

      applyRbacToElements();
    };

    /**
     * Recalculate payrolls and refresh dependent views.
     * @param {string} monthLabel
     * @param {string} notice
     * @param {string} detailNote
     * @returns {void}
     */
    const applyPayrollCalculation = (monthLabel, notice, detailNote) => {
      state.payrolls = state.employees.map((employee) => calculatePayroll(employee, monthLabel));
      updateMonthlyHistory();
      renderPayroll();
      renderSummary();
      renderPayrollNotice(notice);
      renderPayrollDetail(state.payrolls[0], detailNote);
      renderChart();
      renderSettlementDashboard();
    };

    /**
     * Mark settlement flow as stale after data changes.
     * @param {string} reason
     * @param {{notify?: boolean}} options
     * @returns {void}
     */
    const markSettlementDirty = (reason, options = {}) => {
      state.settlement.needsConfirm = true;
      state.settlement.needsRecalc = true;
      if (state.settlement.completedAt) {
        state.settlement.completedAt = "";
      }
      if (options.notify && reason) {
        setAction(reason);
      }
      renderSettlementDashboard();
    };

    /**
     * Apply a demo salary structure change and refresh dependent views.
     * @param {string} toastMessage
     * @param {string} activityMessage
     * @returns {void}
     */
    const applySalaryStructureChange = (toastMessage, activityMessage) => {
      touchSettlementSource("salaryStructure");
      markSettlementDirty("薪資結構已調整，請重新確認結薪資料。");
      renderSalaryStructure();
      renderSettlementDashboard();
      if (activityMessage) {
        setAction(activityMessage);
        logActivity(activityMessage);
      }
      if (toastMessage) {
        showToast(toastMessage);
      }
    };

    /**
     * Handle salary structure submit action.
     * @returns {void}
     */
    const handleSalaryStructureSubmit = () => {
      if (!ensurePermission("payroll.edit", "權限不足，無法儲存薪資結構")) {
        return;
      }
      const values = collectSalaryStructureFormData();
      if (!values) {
        return;
      }
      const targetIndex = state.employees.findIndex((item) => item.employeeId === values.employeeId);
      if (targetIndex < 0) {
        showToast("找不到員工資料");
        return;
      }
      const targetEmployee = state.employees[targetIndex];
      const employmentTypeCode = values.employmentTypeCode === "2" ? "2" : "1";
      const employmentTypeLabel = employmentTypeCode === "2" ? "時薪" : "月薪";
      const updatedEmployee = {
        ...targetEmployee,
        employmentTypeCode,
        employmentTypeLabel,
        baseSalary: values.baseSalary,
        allowances: {
          ...targetEmployee.allowances,
          ...values.allowances
        }
      };
      state.employees = state.employees.map((employee) =>
        employee.employeeId === values.employeeId ? updatedEmployee : employee
      );
      const monthLabel = document.getElementById("payrollMonth").value || dayjs().format("YYYY-MM");
      state.payrolls = state.employees.map((employee) => calculatePayroll(employee, monthLabel));
      updateMonthlyHistory();
      renderPayroll();
      renderSummary();
      renderEmployeePreview(updatedEmployee, "薪資結構已更新。");
      renderEmployeeDetail(updatedEmployee);
      renderPayrollDetail(state.payrolls.find((item) => item.employeeId === values.employeeId));

      const isCreate = state.salaryStructureMode === "create";
      const actionText = isCreate ? "建立薪資結構" : "調整薪資結構";
      applySalaryStructureChange(isCreate ? "薪資結構已建立" : "薪資結構已更新", `${actionText}：${updatedEmployee.chineseName} (${updatedEmployee.employeeId})`);
      state.salaryStructureMode = "edit";
      openPage("salary-structure", "薪資結構", true, false);
    };

    /**
     * Confirm settlement step 1 after validation checks.
     * @returns {void}
     */
    const handleSettlementConfirm = () => {
      if (!ensurePermission("settlement.edit", "權限不足，無法執行結薪確認")) {
        return;
      }
      const checks = buildSettlementChecks();
      const sources = buildSettlementSources();
      const gate = buildSettlementGateState(checks, sources);
      if (!gate.canConfirm) {
        showToast("請先排除阻擋項目");
        return;
      }
      const now = dayjs().format("YYYY-MM-DD HH:mm");
      state.settlement.confirmedAt = now;
      state.settlement.needsConfirm = false;
      state.settlement.needsRecalc = true;
      state.settlement.completedAt = "";
      setAction("已完成資料確認");
      logActivity("完成結薪資料確認");
      showToast("資料確認完成");
      renderSettlementDashboard();
    };

    /**
     * Run settlement calculation step.
     * @returns {void}
     */
    const handleSettlementCalculate = () => {
      if (!ensurePermission("settlement.edit", "權限不足，無法執行結薪計算")) {
        return;
      }
      const checks = buildSettlementChecks();
      const sources = buildSettlementSources();
      const gate = buildSettlementGateState(checks, sources);
      if (!gate.canCalculate) {
        showToast("請先完成資料確認");
        return;
      }
      const monthLabel = document.getElementById("payrollMonth").value;
      applyPayrollCalculation(monthLabel, "由結薪作業執行計算。", "由結薪作業試算。");
      const now = dayjs().format("YYYY-MM-DD HH:mm");
      state.settlement.calculatedAt = now;
      state.settlement.needsRecalc = false;
      state.settlement.completedAt = "";
      setAction(`已完成 ${monthLabel} 結薪計算`);
      logActivity(`執行結薪計算：${monthLabel}`);
      showToast("資料計算完成");
      renderSettlementDashboard();
    };

    /**
     * Complete settlement step 3 and lock the flow.
     * @returns {void}
     */
    const handleSettlementComplete = () => {
      if (!ensurePermission("settlement.edit", "權限不足，無法完成結薪")) {
        return;
      }
      const checks = buildSettlementChecks();
      const sources = buildSettlementSources();
      const gate = buildSettlementGateState(checks, sources);
      if (!gate.canComplete) {
        showToast("請先完成資料計算");
        return;
      }
      const now = dayjs().format("YYYY-MM-DD HH:mm");
      state.settlement.completedAt = now;
      state.settlement.lock = true;
      setAction("結薪已完成並鎖定");
      logActivity("結薪完成並鎖定");
      showToast("結薪完成，流程已鎖定");
      renderSettlementDashboard();
    };

    /**
     * Reopen settlement flow after completion.
     * @returns {void}
     */
    const handleSettlementReopen = () => {
      if (!ensurePermission("settlement.edit", "權限不足，無法重新開帳")) {
        return;
      }
      if (!state.settlement.lock && !state.settlement.completedAt) {
        showToast("尚未完成結薪");
        return;
      }
      state.settlement.lock = false;
      state.settlement.completedAt = "";
      state.settlement.confirmedAt = "";
      state.settlement.calculatedAt = "";
      state.settlement.needsConfirm = true;
      state.settlement.needsRecalc = true;
      setAction("已重新開帳，請重新確認資料");
      logActivity("重新開帳");
      showToast("已重新開帳");
      renderSettlementDashboard();
    };

    /**
     * Generate a summary report entry and refresh report views.
     * @param {string} note
     * @param {string} detailNote
     * @param {boolean} openDetail
     * @returns {{reportId: string, type: string, format: string, createdAt: string, status: string}}
     */
    const generateSummaryReport = (note, detailNote, openDetail) => {
      const now = dayjs();
      const report = {
        reportId: `RPT-${now.format("YYYYMM")}-SUM-${randomInt(10, 99)}`,
        type: "薪資總表",
        format: "XLSX",
        createdAt: now.format("YYYY-MM-DD HH:mm"),
        status: "已完成"
      };
      state.reportHistory.unshift(report);
      ensureReportFilterForReport(report);
      populateReportMonthOptions();
      applyReportFilter();
      renderReportNotice(report, note);
      renderReportDetail(report, detailNote);
      if (openDetail) {
        openPage("report-detail", "報表明細", true, false);
      }
      return report;
    };

    /**
     * Generate a payslip report entry and refresh report views.
     * @param {string} note
     * @param {string} detailNote
     * @param {boolean} openDetail
     * @returns {{report: {reportId: string, type: string, format: string, createdAt: string, status: string}, employee: {employeeId: string, chineseName: string}}}
     */
    const generatePayslipReport = (note, detailNote, openDetail) => {
      const now = dayjs();
      const employee = randomChoice(state.employees);
      const report = {
        reportId: `RPT-${now.format("YYYYMM")}-PS-${employee.employeeId}`,
        type: `個人薪資單：${employee.chineseName}`,
        format: "PDF",
        createdAt: now.format("YYYY-MM-DD HH:mm"),
        status: "已完成"
      };
      state.reportHistory.unshift(report);
      ensureReportFilterForReport(report);
      populateReportMonthOptions();
      applyReportFilter();
      renderReportNotice(report, note);
      renderReportDetail(report, detailNote);
      if (openDetail) {
        openPage("report-detail", "報表明細", true, false);
      }
      return { report, employee };
    };

    /**
     * Handle payroll recalculation from the payroll page.
     * @returns {void}
     */
    const handlePayrollRecalc = () => {
      if (!ensurePermission("payroll.edit", "權限不足，無法執行薪資試算")) {
        return;
      }
      if (state.settlement.lock) {
        showToast("結薪已完成，請重新開帳");
        return;
      }
      const monthLabel = document.getElementById("payrollMonth").value;
      applyPayrollCalculation(monthLabel, "已重新產生加班與保險扣款結果。", "由本次試算產生。");
      const now = dayjs().format("YYYY-MM-DD HH:mm");
      state.settlement.calculatedAt = now;
      state.settlement.needsRecalc = false;
      state.settlement.completedAt = "";
      setAction(`已完成 ${monthLabel} 薪資試算`);
      logActivity(`執行薪資試算：${monthLabel}`);
      showToast("薪資試算完成");
      openPage("payroll-detail", "薪資明細", true, false);
      renderSettlementDashboard();
    };

    /**
     * Handle payroll month change and refresh views.
     * @returns {void}
     */
    const handlePayrollMonthChange = () => {
      if (!ensurePermission("payroll.edit", "權限不足，無法變更計薪月份")) {
        return;
      }
      const monthLabel = document.getElementById("payrollMonth").value;
      applyPayrollCalculation(monthLabel, "已切換月份並更新試算結果。", "已依新月份更新資料。");
      markSettlementDirty("計薪月份已切換，請重新確認結薪資料。");
      setAction(`已切換試算月份：${monthLabel}`);
    };

    /**
     * Handle report center summary export.
     * @returns {void}
     */
    const handleReportExportSummary = () => {
      if (!ensurePermission("reports.export", "權限不足，無法產生薪資總表")) {
        return;
      }
      generateSummaryReport("由「產生薪資總表」產出。", "由薪資總表匯出。", true);
      setAction("已產生薪資總表");
      logActivity("產生薪資總表");
      showToast("薪資總表已產生");
    };

    /**
     * Handle report center payslip export.
     * @returns {void}
     */
    const handleReportExportPayslip = () => {
      if (!ensurePermission("reports.export", "權限不足，無法產生個人薪資單")) {
        return;
      }
      const { employee } = generatePayslipReport("由「產生個人薪資單」產出。", "由個人薪資單匯出。", true);
      setAction(`已產生 ${employee.chineseName} 的薪資單`);
      logActivity(`產生個人薪資單：${employee.chineseName} (${employee.employeeId})`);
      showToast("個人薪資單已產生");
    };

    /**
     * Handle settlement summary export.
     * @returns {void}
     */
    const handleSettlementExportSummary = () => {
      if (!ensurePermission("reports.export", "權限不足，無法產生薪資總表")) {
        return;
      }
      const canExport = !state.settlement.needsRecalc && state.settlement.calculatedAt;
      if (!canExport) {
        showToast("請先完成資料計算");
        return;
      }
      generateSummaryReport("由結薪作業產出。", "由結薪作業匯出。", false);
      setAction("已產生薪資總表");
      logActivity("結薪匯出：薪資總表");
      showToast("薪資總表已產生");
    };

    /**
     * Handle settlement payslip export.
     * @returns {void}
     */
    const handleSettlementExportPayslip = () => {
      if (!ensurePermission("reports.export", "權限不足，無法產生個人薪資單")) {
        return;
      }
      const canExport = !state.settlement.needsRecalc && state.settlement.calculatedAt;
      if (!canExport) {
        showToast("請先完成資料計算");
        return;
      }
      const { employee } = generatePayslipReport("由結薪作業產出。", "由結薪作業匯出。", false);
      setAction(`已產生 ${employee.chineseName} 的薪資單`);
      logActivity(`結薪匯出：個人薪資單 ${employee.chineseName} (${employee.employeeId})`);
      showToast("個人薪資單已產生");
    };

    /**
     * Recalculate payrolls after grade updates.
     * @param {string} note
     * @returns {void}
     */
    const updatePayrollAfterGradeChange = (note) => {
      const monthLabel = document.getElementById("payrollMonth").value || dayjs().format("YYYY-MM");
      applyPayrollCalculation(monthLabel, note, note);
      markSettlementDirty("級距資料已更新，請重新確認結薪資料。");
    };

    const renderActivities = () => {
      document.getElementById("activityList").innerHTML = state.activities
        .map((item) => `
          <li class="list__item">
            <div>${item.text}</div>
            <span class="list__meta">${item.time}</span>
          </li>
        `)
        .join("");
    };

    const buildChart = (labels, data) => {
      const canvas = document.getElementById("payrollChart");
      if (!canvas || !window.Chart) {
        return;
      }
      const styles = getComputedStyle(document.documentElement);
      const colorGross = styles.getPropertyValue("--chart-gross").trim() || "#2f7f7b";
      const colorDeduction = styles.getPropertyValue("--chart-deduction").trim() || "#c65c2c";
      const colorNet = styles.getPropertyValue("--chart-net").trim() || "#2a4a3f";
      const existingChart = window.payrollChartInstance || Chart.getChart(canvas);
      if (existingChart && typeof existingChart.destroy === "function") {
        existingChart.destroy();
      }
      window.payrollChartInstance = new Chart(canvas, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "實領總額（按月）",
              data: data.net,
              borderColor: colorNet,
              backgroundColor: "rgba(42, 74, 63, 0.14)",
              fill: false,
              tension: 0.35,
              pointRadius: 3
            },
            {
              label: "應發總額（按月）",
              data: data.gross,
              borderColor: colorGross,
              backgroundColor: "rgba(47, 127, 123, 0.15)",
              fill: false,
              tension: 0.35,
              pointRadius: 3
            },
            {
              label: "扣款總額（按月）",
              data: data.deduction,
              borderColor: colorDeduction,
              backgroundColor: "rgba(198, 92, 44, 0.12)",
              fill: false,
              tension: 0.35,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${currency.format(context.parsed.y)}`
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: (value) => `${formatter.format(value / 1000)}k`
              }
            }
          }
        }
      });
    };

    let isRenderingChart = false;
    const renderChart = () => {
      if (isRenderingChart || !window.Chart) {
        return;
      }
      if (!state.monthlyHistory.length) {
        updateMonthlyHistory();
      }
      const chartLabels = state.monthlyHistory.map((item) => item.month);
      const chartData = {
        gross: state.monthlyHistory.map((item) => item.grossTotal),
        deduction: state.monthlyHistory.map((item) => item.deductionTotal),
        net: state.monthlyHistory.map((item) => item.netTotal)
      };
      isRenderingChart = true;
      try {
        buildChart(chartLabels, chartData);
      } finally {
        isRenderingChart = false;
      }
    };

    const showToast = (message) => {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("toast--show");
      setTimeout(() => toast.classList.remove("toast--show"), 2400);
    };

    /**
     * Validate permission before running an action.
     * @param {string} permission
     * @param {string} message
     * @returns {boolean}
     */
    const ensurePermission = (permission, message) => {
      if (hasPermission(permission)) {
        return true;
      }
      showToast(message || "權限不足");
      return false;
    };

    const setAction = (message) => {
      const actionText = document.getElementById("actionText");
      if (actionText) {
        actionText.textContent = message;
      }
    };

    const logActivity = (text) => {
      const now = dayjs();
      state.activities.unshift({
        text,
        time: now.format("MM/DD HH:mm")
      });
      state.activities = state.activities.slice(0, 5);
      renderActivities();
    };

    const updateRangeButtons = () => {
      document.querySelectorAll(".chart-range").forEach((button) => {
        button.classList.toggle("chart-range--active", button.dataset.range === String(state.historyRange));
      });
    };

    const populateMonthOptions = () => {
      const select = document.getElementById("payrollMonth");
      const options = [];
      for (let i = 0; i < 6; i += 1) {
        const month = dayjs().subtract(i, "month").format("YYYY-MM");
        options.push(`<option value="${month}">${month}</option>`);
      }
      select.innerHTML = options.join("");
    };

    const populateRoleOptions = () => {
      const select = document.getElementById("roleSelect");
      if (!select) {
        return;
      }
      select.innerHTML = roleDefinitions
        .map((role) => `<option value="${role.id}">${role.label}</option>`)
        .join("");
      select.value = state.currentRole;
      renderRoleStatus();
      applyRbacToElements();
    };

    const initData = () => {
      state.employees = Array.from({ length: 8 }, (_, index) => createEmployee(index));
      state.insuranceVersions = generateInsuranceVersions();
      state.insuranceRates = generateInsuranceRates();
      state.gradeFormState = {
        labor: { mode: "empty", code: null },
        health: { mode: "empty", code: null }
      };
      state.gradeVersion = {
        labor: {
          activeCode: "LG2025-01",
          versions: [
            { code: "LG2025-01", effectiveDate: "2025-01-01", status: "啟用" },
            { code: "LG2024-01", effectiveDate: "2024-01-01", status: "停用" },
            { code: "LG2023-01", effectiveDate: "2023-01-01", status: "停用" }
          ]
        },
        health: {
          activeCode: "HG2025-01",
          versions: [
            { code: "HG2025-01", effectiveDate: "2025-01-01", status: "啟用" },
            { code: "HG2024-01", effectiveDate: "2024-01-01", status: "停用" }
          ]
        }
      };
      state.gradeData = {
        labor: buildGradeData("labor", state.gradeVersion.labor.activeCode),
        health: buildGradeData("health", state.gradeVersion.health.activeCode)
      };
      state.settlement = {
        confirmedAt: "",
        calculatedAt: "",
        completedAt: "",
        needsConfirm: true,
        needsRecalc: true,
        lock: false
      };
      initSettlementData();
      const monthLabel = document.getElementById("payrollMonth").value || dayjs().format("YYYY-MM");
      state.payrolls = state.employees.map((employee) => calculatePayroll(employee, monthLabel));
      state.reportHistory = generateReportHistory(state.employees);
      state.reportFilterMonth = "all";
      state.activities = generateActivities();
      updateMonthlyHistory();

      renderSummary();
      renderEmployees();
      renderInsurance();
      renderGradeVersion("labor");
      renderGradeTable("labor");
      renderGradeVersion("health");
      renderGradeTable("health");
      renderPayroll();
      populateReportMonthOptions();
      applyReportFilter();
      renderActivities();
      state.pendingEmployee = createEmployee(state.employees.length);
      renderEmployeePreview(state.employees[0], "預設顯示首位人事資料。");
      renderEmployeeCreate(state.pendingEmployee);
      setEmployeeFormMeta("create");
      renderEmployeeDetail(state.employees[0]);
      renderInsuranceNotice();
      renderInsuranceDetail();
      renderPayrollNotice();
      renderPayrollDetail(state.payrolls[0]);
      setAction("已載入資料，請選擇功能頁面。");

      renderChart();
      updateRangeButtons();
      renderSettlementDashboard();
    };

    const openPage = (pageId, label, updateHash = true, announce = true) => {
      const fallback = getFallbackPage();
      if (!canAccessPage(pageId)) {
        showToast("權限不足，無法進入此功能");
        if (pageId !== fallback) {
          history.replaceState(null, "", `#${fallback}`);
          openPage(fallback, null, false, false);
        }
        return;
      }
      const panel = document.getElementById(pageId);
      if (!panel) {
        return;
      }
      document.querySelectorAll(".panel").forEach((item) => {
        item.classList.toggle("panel--active", item.id === pageId);
      });
      const tabToActivate = document.querySelector(`.tab[data-tab="${pageId}"]`);
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.classList.toggle("tab--active", tab === tabToActivate);
      });
      const resolvedLabel = label || panel.dataset.title || panel.querySelector(".panel__title")?.textContent?.trim();
      if (resolvedLabel) {
        setAction(`已開啟「${resolvedLabel}」`);
        if (announce) {
          showToast(`已開啟 ${resolvedLabel}`);
        }
      }
      if (updateHash) {
        history.replaceState(null, "", `#${pageId}`);
      }
    };

    const handleHashChange = () => {
      const hash = window.location.hash.replace("#", "");
      if (hash && document.getElementById(hash)) {
        openPage(hash, null, false, false);
      } else {
        openPage("overview", null, false, false);
      }
    };

    const navigateTo = (pageId, label) => {
      if (!pageId) {
        return;
      }
      openPage(pageId, label, true, true);
    };

    document.addEventListener("DOMContentLoaded", () => {
      populateMonthOptions();
      initData();
      populateRoleOptions();
      handleHashChange();
      window.addEventListener("hashchange", handleHashChange);

      const roleSelect = document.getElementById("roleSelect");
      if (roleSelect) {
        roleSelect.addEventListener("change", () => {
          state.currentRole = roleSelect.value;
          const role = getCurrentRole();
          renderRoleStatus();
          renderSettlementDashboard();
          applyRbacToElements();
          const activePage = document.querySelector(".panel--active")?.id;
          if (activePage && !canAccessPage(activePage)) {
            openPage(getFallbackPage(), null, true, false);
          }
          showToast(`已切換角色：${role.label}`);
        });
      }

      document.getElementById("settlementConfirm").addEventListener("click", handleSettlementConfirm);
      document.getElementById("settlementCalculate").addEventListener("click", handleSettlementCalculate);
      document.getElementById("settlementComplete").addEventListener("click", handleSettlementComplete);
      document.getElementById("settlementReopen").addEventListener("click", handleSettlementReopen);
      document.getElementById("settlementExportSummary").addEventListener("click", handleSettlementExportSummary);
      document.getElementById("settlementExportPayslip").addEventListener("click", handleSettlementExportPayslip);

      const addSalaryStructure = document.getElementById("addSalaryStructure");
      if (addSalaryStructure) {
        addSalaryStructure.addEventListener("click", () => {
          if (!ensurePermission("payroll.edit", "權限不足，無法建立薪資結構")) {
            return;
          }
          openSalaryStructureDetail(
            state.employees[0],
            "create",
            "建立薪資結構草稿，請確認本薪與津貼項目。"
          );
        });
      }

      const salaryStructureTable = document.getElementById("salaryStructureTable");
      if (salaryStructureTable) {
        salaryStructureTable.addEventListener("click", (event) => {
          const target = event.target.closest("button[data-action=\"adjust-salary\"]");
          if (!target) {
            return;
          }
          if (!ensurePermission("payroll.edit", "權限不足，無法調整薪資結構")) {
            return;
          }
          const employeeId = target.dataset.employeeId || "";
          const employeeName = target.dataset.employeeName || "";
          const employee = state.employees.find((item) => item.employeeId === employeeId);
          if (!employee) {
            showToast("找不到員工資料");
            return;
          }
          openSalaryStructureDetail(
            employee,
            "edit",
            `已載入 ${employeeName || employee.chineseName} 的薪資結構，請完成調整。`
          );
        });
      }

      const submitSalaryStructure = document.getElementById("submitSalaryStructure");
      if (submitSalaryStructure) {
        submitSalaryStructure.addEventListener("click", handleSalaryStructureSubmit);
      }

      document.addEventListener("input", (event) => {
        const target = event.target.closest("#salaryStructureFormFields .salary-structure-input");
        if (!target) {
          return;
        }
        updateSalaryStructurePreview();
      });

      document.addEventListener("change", (event) => {
        const employeeSelect = event.target.closest("#salaryEmployeeSelect");
        if (employeeSelect) {
          const employeeId = employeeSelect.value || "";
          const employee = state.employees.find((item) => item.employeeId === employeeId);
          if (!employee) {
            showToast("找不到員工資料");
            return;
          }
          renderSalaryStructureDetail(employee, "已切換員工，請確認薪資結構內容。");
          setSalaryStructureMeta(state.salaryStructureMode, employee);
          return;
        }
        const inputTarget = event.target.closest("#salaryStructureFormFields .salary-structure-input");
        if (!inputTarget) {
          return;
        }
        updateSalaryStructurePreview();
      });

      document.addEventListener("click", (event) => {
        const navTarget = event.target.closest("[data-nav]");
        if (navTarget) {
          const label = navTarget.dataset.label || navTarget.textContent?.trim();
          navigateTo(navTarget.dataset.nav, label);
        }
      });

      document.addEventListener("click", (event) => {
        const rangeButton = event.target.closest(".chart-range");
        if (!rangeButton) {
          return;
        }
        state.historyRange = Number(rangeButton.dataset.range) || 6;
        updateMonthlyHistory();
        renderChart();
        updateRangeButtons();
        setAction(`已切換圖表範圍：最近 ${state.historyRange} 個月`);
      });

      document.addEventListener("click", (event) => {
        const actionTarget = event.target.closest("[data-grade-action]");
        if (!actionTarget) {
          return;
        }
        const action = actionTarget.dataset.gradeAction;
        const type = actionTarget.dataset.gradeType;
        const code = actionTarget.dataset.gradeCode;
        if (!type) {
          return;
        }
        if (action !== "cancel" && !hasPermission("insurance.edit")) {
          showToast("權限不足，無法操作級距");
          return;
        }
        const typeLabel = type === "labor" ? "勞保" : "健保";

        if (action === "create") {
          setGradeFormState(type, "create");
          setAction(`已開啟${typeLabel}級距新增`);
          showToast(`已開啟${typeLabel}級距新增`);
          return;
        }

        if (action === "view" && code) {
          setGradeFormState(type, "view", code);
          setAction(`已檢視${typeLabel}級距 ${code}`);
          showToast(`已檢視${typeLabel}級距`);
          return;
        }

        if (action === "edit" && code) {
          setGradeFormState(type, "edit", code);
          setAction(`已開啟${typeLabel}級距修改：${code}`);
          showToast(`已開啟${typeLabel}級距修改`);
          return;
        }

        if (action === "save") {
          saveGradeForm(type);
          return;
        }

        if (action === "cancel") {
          setGradeFormState(type, "empty", null);
          setAction(`已返回${typeLabel}級距清單`);
          return;
        }

      });

      document.addEventListener("click", (event) => {
        const versionTarget = event.target.closest("[data-grade-version-action]");
        if (!versionTarget) {
          return;
        }
        const action = versionTarget.dataset.gradeVersionAction;
        const type = versionTarget.dataset.gradeType || document.getElementById("gradeVersionModal")?.dataset.gradeType;
        const code = versionTarget.dataset.gradeCode;
        if (!type) {
          return;
        }
        if (action !== "cancel" && !hasPermission("insurance.edit")) {
          showToast("權限不足，無法操作版本");
          return;
        }
        const typeLabel = type === "labor" ? "勞保" : "健保";

        if (action === "create") {
          renderGradeVersionForm(type);
          setAction(`已開啟${typeLabel}級距版本新增`);
          showToast(`已開啟${typeLabel}級距版本新增`);
          return;
        }

        if (action === "save") {
          saveGradeVersionForm(type);
          return;
        }

        if (action === "cancel") {
          closeGradeVersionModal();
          return;
        }

        if ((action === "activate" || action === "deactivate") && code) {
          const versionData = state.gradeVersion?.[type] || { activeCode: null, versions: [] };
          let activeCode = versionData.activeCode;
          const enabledVersions = versionData.versions.filter((item) => item.status === "啟用");
          if (action === "deactivate" && enabledVersions.length <= 1) {
            showToast("至少需保留一個啟用版本");
            return;
          }
          const nextVersions = versionData.versions.map((item) => {
            if (item.code !== code) {
              return action === "activate" ? { ...item, status: "停用" } : item;
            }
            const nextStatus = action === "activate" ? "啟用" : "停用";
            return { ...item, status: nextStatus };
          });
          if (action === "activate") {
            activeCode = code;
          } else if (activeCode === code) {
            activeCode = null;
          }
          state.gradeVersion[type] = {
            ...versionData,
            activeCode,
            versions: nextVersions
          };
          touchSettlementSource("insurance");
          renderGradeVersion(type);
          renderGradeTable(type);
          renderInsurance();
          updatePayrollAfterGradeChange(`${typeLabel}級距版本狀態已更新。`);
          setAction(`已更新${typeLabel}級距版本狀態`);
          logActivity(`更新${typeLabel}級距版本狀態：${code}`);
          showToast(`${typeLabel}級距版本狀態已更新`);
        }
      });

      document.getElementById("addEmployee").addEventListener("click", () => {
        if (!ensurePermission("employees.edit", "權限不足，無法新增員工")) {
          return;
        }
        const newEmployee = createEmployee(state.employees.length);
        state.pendingEmployee = newEmployee;
        state.employeeFormMode = "create";
        state.editingEmployeeId = null;
        renderEmployeeCreate(newEmployee);
        openPage("employee-create", "新增員工", true, false);
        setEmployeeFormMeta("create");
        setAction(`已開啟新增員工頁面（${newEmployee.chineseName}）`);
        logActivity(`開啟新增員工頁面：${newEmployee.chineseName}`);
        showToast("已開啟新增員工頁面");
      });

      document.getElementById("submitEmployeeCreate").addEventListener("click", () => {
        if (!ensurePermission("employees.edit", "權限不足，無法儲存員工資料")) {
          return;
        }
        const baseEmployee = state.employeeFormMode === "edit"
          ? state.employees.find((item) => item.employeeId === state.editingEmployeeId)
          : state.pendingEmployee;
        const newEmployee = collectEmployeeFormData(baseEmployee);
        if (!newEmployee) {
          return;
        }
        const duplicate = state.employees.find((employee) => employee.employeeId === newEmployee.employeeId);
        if (state.employeeFormMode === "create" && duplicate) {
          showToast("員工編號已存在");
          return;
        }
        if (state.employeeFormMode === "edit" && duplicate && duplicate.employeeId !== state.editingEmployeeId) {
          showToast("員工編號已存在");
          return;
        }
        if (state.employeeFormMode === "edit" && state.editingEmployeeId) {
          state.employees = state.employees.map((employee) =>
            employee.employeeId === state.editingEmployeeId ? newEmployee : employee
          );
        } else {
          state.employees.unshift(newEmployee);
        }
        touchSettlementSource("employees");
        state.payrolls = state.employees.map((employee) => calculatePayroll(employee, document.getElementById("payrollMonth").value));
        updateMonthlyHistory();
        renderEmployees();
        renderPayroll();
        renderSummary();
        renderPayrollNotice(state.employeeFormMode === "edit" ? "已更新員工資料並重新試算薪資。" : "已新增員工後重新試算薪資。");
        renderEmployeePreview(newEmployee, state.employeeFormMode === "edit" ? "已更新員工資料。" : "已新增並納入員工清單。");
        renderEmployeeDetail(newEmployee);
        renderPayrollDetail(state.payrolls.find((item) => item.employeeId === newEmployee.employeeId));
        renderChart();
        markSettlementDirty("員工資料已更新，請重新確認結薪資料。");
        state.pendingEmployee = createEmployee(state.employees.length);
        renderEmployeeCreate(state.pendingEmployee);
        openPage("employees", "人事資料", true, false);
        if (state.employeeFormMode === "edit") {
          setAction(`已更新員工 ${newEmployee.chineseName} (${newEmployee.employeeId})`);
          logActivity(`更新員工資料：${newEmployee.chineseName} (${newEmployee.employeeId})`);
          showToast("員工資料已更新");
        } else {
          setAction(`已新增員工 ${newEmployee.chineseName} (${newEmployee.employeeId})`);
          logActivity(`新增員工：${newEmployee.chineseName} (${newEmployee.employeeId})`);
          showToast("員工資料已新增");
        }
        state.employeeFormMode = "create";
        state.editingEmployeeId = null;
        setEmployeeFormMeta("create");
      });

      document.getElementById("recalcPayroll").addEventListener("click", handlePayrollRecalc);

      document.getElementById("payrollMonth").addEventListener("change", handlePayrollMonthChange);

      const reportMonthFilter = document.getElementById("reportMonthFilter");
      if (reportMonthFilter) {
        reportMonthFilter.addEventListener("change", () => {
          state.reportFilterMonth = reportMonthFilter.value;
          applyReportFilter();
          const label = state.reportFilterMonth === "all" ? "全部月份" : state.reportFilterMonth;
          setAction(`已切換報表月份：${label}`);
        });
      }

      const gradeModal = document.getElementById("gradeModal");
      const gradeModalClose = document.getElementById("gradeModalClose");
      if (gradeModal && gradeModalClose) {
        gradeModalClose.addEventListener("click", () => {
          const type = gradeModal.dataset.gradeType;
          if (type) {
            setGradeFormState(type, "empty", null);
          } else {
            gradeModal.classList.remove("modal--open");
            gradeModal.setAttribute("aria-hidden", "true");
            gradeModal.removeAttribute("data-grade-type");
          }
        });
        gradeModal.addEventListener("click", (event) => {
          if (event.target === gradeModal) {
            const type = gradeModal.dataset.gradeType;
            if (type) {
              setGradeFormState(type, "empty", null);
            } else {
              gradeModal.classList.remove("modal--open");
              gradeModal.setAttribute("aria-hidden", "true");
              gradeModal.removeAttribute("data-grade-type");
            }
          }
        });
      }

      const gradeVersionModal = document.getElementById("gradeVersionModal");
      const gradeVersionModalClose = document.getElementById("gradeVersionModalClose");
      if (gradeVersionModal && gradeVersionModalClose) {
        gradeVersionModalClose.addEventListener("click", () => {
          closeGradeVersionModal();
        });
        gradeVersionModal.addEventListener("click", (event) => {
          if (event.target === gradeVersionModal) {
            closeGradeVersionModal();
          }
        });
      }

      document.getElementById("exportSummary").addEventListener("click", handleReportExportSummary);

      document.getElementById("exportPayslip").addEventListener("click", handleReportExportPayslip);

      document.getElementById("toggleVersion").addEventListener("click", () => {
        if (!ensurePermission("insurance.edit", "權限不足，無法切換保險版本")) {
          return;
        }
        const before = state.insuranceVersions.map((item) => ({ ...item }));
        state.insuranceVersions = state.insuranceVersions.map((item) => ({
          ...item,
          code: item.type === "勞保" ? "L2024-02" : "H2024-02",
          effectiveDate: "2024-07-01",
          status: "啟用"
        }));
        const after = state.insuranceVersions.map((item) => ({ ...item }));
        state.insuranceSnapshots = { before, after };
        touchSettlementSource("insurance");
        renderInsurance();
        renderInsuranceNotice("已切換至新版版本，生效日更新為 2024-07-01。");
        renderInsuranceDetail("版本已更新為最新資料。");
        markSettlementDirty("保險版本已更新，請重新確認結薪資料。");
        setAction("已切換保險版本");
        logActivity("切換保險版本：L2024-02 / H2024-02");
        showToast("已切換至新版保險版本");
        openPage("insurance-detail", "保險版本明細", true, false);
      });

      document.getElementById("employeeTable").addEventListener("click", (event) => {
        const target = event.target.closest("button[data-action=\"view-employee\"]");
        if (target) {
          const employeeName = target.dataset.employeeName;
          const employeeId = target.dataset.employeeId;
          const employee = state.employees.find((item) => item.employeeId === employeeId);
          renderEmployeePreview(employee, "由員工清單點選「查看」載入。");
          renderEmployeeDetail(employee);
          setAction(`已查看員工 ${employeeName} (${employeeId})`);
          logActivity(`查看員工資料：${employeeName} (${employeeId})`);
          showToast(`已開啟 ${employeeName} 的詳細資料`);
          openPage("employee-detail", "員工明細", true, false);
          return;
        }

        const editTarget = event.target.closest("button[data-action=\"edit-employee\"]");
        if (!editTarget) {
          return;
        }
        if (!ensurePermission("employees.edit", "權限不足，無法編輯員工")) {
          return;
        }
        const employeeName = editTarget.dataset.employeeName;
        const employeeId = editTarget.dataset.employeeId;
        const employee = state.employees.find((item) => item.employeeId === employeeId);
        if (!employee) {
          return;
        }
        state.employeeFormMode = "edit";
        state.editingEmployeeId = employeeId;
        renderEmployeeCreate(employee);
        setEmployeeFormMeta("edit", employee);
        openPage("employee-create", "編輯員工", true, false);
        setAction(`已開啟編輯員工 ${employeeName}`);
        logActivity(`編輯員工資料：${employeeName} (${employeeId})`);
        showToast("已開啟員工編輯頁面");
      });

      document.getElementById("payrollTable").addEventListener("click", (event) => {
        const target = event.target.closest("button[data-action=\"view-payroll\"]");
        if (!target) {
          return;
        }
        const payrollId = target.dataset.payrollId;
        const payroll = state.payrolls.find((item) => item.payrollId === payrollId);
        renderPayrollDetail(payroll, "由薪資清單查看。");
        logActivity(`查看薪資明細：${payrollId}`);
        showToast("已開啟薪資明細");
        openPage("payroll-detail", "薪資明細", true, false);
      });

      document.getElementById("reportTable").addEventListener("click", (event) => {
        const target = event.target.closest("button[data-action=\"view-report\"]");
        if (!target) {
          return;
        }
        const reportId = target.dataset.reportId;
        const report = state.reports.find((item) => item.reportId === reportId);
        renderReportDetail(report, "由報表清單查看。");
        logActivity(`查看報表：${reportId}`);
        showToast("已開啟報表明細");
        openPage("report-detail", "報表明細", true, false);
      });
    });
  </script>
</body>
</html>
